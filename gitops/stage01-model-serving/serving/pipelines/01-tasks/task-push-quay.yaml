apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: push-to-quay
  namespace: private-ai-demo
  labels:
    app.kubernetes.io/name: push-quay
    app.kubernetes.io/component: pipeline-task
    app.kubernetes.io/part-of: private-ai-demo
  annotations:
    argocd.argoproj.io/sync-wave: "3"
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/tags: "image-push,buildah,quay"
    tekton.dev/displayName: "Push to Quay.io"
spec:
  description: >-
    Pushes a built ModelCar image to Quay.io external registry.
    This is Task 3b of 4 in the ModelCar pipeline (runs in parallel with push-to-internal-registry).
    
  params:
    - name: SOURCE_IMAGE
      type: string
      description: Source image reference (e.g., image-registry.openshift-image-registry.svc:5000/namespace/name:tag)
    
    - name: QUAY_ORG
      type: string
      description: Quay.io organization name
    
    - name: QUAY_REPO
      type: string
      description: Quay.io repository name
    
    - name: QUAY_TAG
      type: string
      description: Tag for the Quay image
      default: "latest"
    
    - name: TLSVERIFY
      type: string
      description: Verify TLS on the registry endpoint
      default: "true"

  workspaces:
    - name: source
      description: Workspace containing buildah storage
    - name: quay-auth
      description: Quay.io authentication secret
      optional: true

  results:
    - name: IMAGE_URL
      description: Full URL of the pushed Quay image
    
    - name: IMAGE_DIGEST
      description: Digest of the pushed image
    
    - name: PUSH_TIME
      description: Time taken to push in seconds

  steps:
    - name: push-to-quay
      image: quay.io/skopeo/stable:latest
      workingDir: /tmp
      computeResources:
        requests:
          memory: "2Gi"
          cpu: "500m"
          ephemeral-storage: "100Gi"  # Required for large model pushes (48GB+ images)
        limits:
          memory: "4Gi"
          cpu: "1"
          ephemeral-storage: "150Gi"
      script: |
        #!/bin/bash
        set -e
        
        START_TIME=$(date +%s)
        
        QUAY_IMAGE="quay.io/$(params.QUAY_ORG)/$(params.QUAY_REPO):$(params.QUAY_TAG)"
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ðŸ“¤ Pushing Image to Quay.io"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Source: $(params.SOURCE_IMAGE)"
        echo "Dest:   $QUAY_IMAGE"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Get ServiceAccount token for internal registry authentication
        TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
        
        # Copy image from internal registry to Quay using skopeo
        echo "ðŸš€ Copying image to Quay..."
        if [ -f "/workspace/quay-auth/.dockerconfigjson" ]; then
          echo "ðŸ” Using Quay auth secret"
          
          skopeo copy \
            --src-creds="serviceaccount:${TOKEN}" \
            --src-tls-verify=false \
            --dest-authfile /workspace/quay-auth/.dockerconfigjson \
            --dest-tls-verify=$(params.TLSVERIFY) \
            --format v2s2 \
            docker://$(params.SOURCE_IMAGE) \
            docker://$QUAY_IMAGE
        else
          echo "âš ï¸  No Quay auth secret - push may fail"
          skopeo copy \
            --src-creds="serviceaccount:${TOKEN}" \
            --src-tls-verify=false \
            --dest-tls-verify=$(params.TLSVERIFY) \
            --format v2s2 \
            docker://$(params.SOURCE_IMAGE) \
            docker://$QUAY_IMAGE
        fi
        
        # Get image digest
        echo "ðŸ“‹ Getting image digest..."
        INSPECT_OUTPUT=$(skopeo inspect --tls-verify=$(params.TLSVERIFY) docker://$QUAY_IMAGE)
        # Extract digest without jq (grep and sed)
        DIGEST=$(echo "$INSPECT_OUTPUT" | grep -o '"Digest":"sha256:[^"]*"' | head -1 | sed 's/"Digest":"//;s/"//')
        
        END_TIME=$(date +%s)
        PUSH_TIME=$((END_TIME - START_TIME))
        
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ… Push to Quay.io Complete!"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Image:  $QUAY_IMAGE"
        echo "Digest: $DIGEST"
        echo "Time:   ${PUSH_TIME}s"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Save results
        echo -n "$QUAY_IMAGE" | tee $(results.IMAGE_URL.path)
        echo -n "$DIGEST" | tee $(results.IMAGE_DIGEST.path)
        echo -n "$PUSH_TIME" > $(results.PUSH_TIME.path)
      
      securityContext:
        capabilities:
          add:
            - SETFCAP

