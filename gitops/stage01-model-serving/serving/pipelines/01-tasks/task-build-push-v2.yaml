apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: build-and-push-v2
  namespace: private-ai-demo
  labels:
    app.kubernetes.io/name: modelcar-pipeline
spec:
  description: Build ModelCar image with Buildah (PVC-backed) and push to Quay

  params:
    - name: quay_org
      type: string
    - name: quay_repo
      type: string
    - name: quay_tag
      type: string
    - name: model_path
      type: string
      default: "models"

  workspaces:
    - name: source
    - name: quay-auth
      mountPath: /workspace/quay-auth

  results:
    - name: IMAGE_URL
    - name: IMAGE_DIGEST

  steps:
    - name: build-and-push
      image: registry.redhat.io/rhel9/buildah:latest
      resources:
        requests:
          memory: "16Gi"
          cpu: "4"
        limits:
          memory: "16Gi"
          cpu: "8"
      script: |
        #!/bin/bash
        set -euo pipefail
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ”¨ Build & Push to Quay [$(date -u +%Y-%m-%dT%H:%M:%SZ)]"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Configure Buildah to use PVC (not node ephemeral)
        export HOME=$(workspaces.source.path)/.buildah-home
        export BUILDAH_STORAGE_ROOT=$(workspaces.source.path)/.buildah-storage
        install -d -m 2775 -g 1000970000 "$HOME" "$BUILDAH_STORAGE_ROOT"
        
        # Create Containerfile (use variable expansion for model_path)
        MODEL_PATH="$(params.model_path)"
        cat > $(workspaces.source.path)/Containerfile <<EOF
        FROM registry.access.redhat.com/ubi9/ubi-micro:9.5
        COPY ${MODEL_PATH} /models
        USER 1001
        CMD ["/bin/sh"]
        EOF
        
        IMAGE_TAG="quay.io/$(params.quay_org)/$(params.quay_repo):$(params.quay_tag)"
        echo "ğŸš€ Building: $IMAGE_TAG"
        
        # Build with explicit no-user-namespace flags
        buildah --root ${BUILDAH_STORAGE_ROOT} --storage-driver=vfs bud \
          --format oci \
          --layers=false \
          --squash \
          --isolation chroot \
          --userns=host \
          --tag "$IMAGE_TAG" \
          --file $(workspaces.source.path)/Containerfile \
          $(workspaces.source.path)
        
        echo "âœ… Build complete"
        echo "ğŸ“¤ Pushing to Quay..."
        
        # Push directly to Quay (no OCI tar!)
        buildah --root ${BUILDAH_STORAGE_ROOT} --storage-driver=vfs push \
          --authfile /workspace/quay-auth/config.json \
          "$IMAGE_TAG" "docker://$IMAGE_TAG"
        
        # Get digest
        DIGEST=$(skopeo inspect --authfile /workspace/quay-auth/config.json \
          "docker://$IMAGE_TAG" | jq -r '.Digest')
        
        echo "âœ… Push complete!"
        echo "   Image:  $IMAGE_TAG"
        echo "   Digest: $DIGEST"
        
        # Write metadata
        mkdir -p $(workspaces.source.path)/.pipeline-metadata
        cat > $(workspaces.source.path)/.pipeline-metadata/quay-push.json <<EOF
        {
          "image": "${IMAGE_TAG}",
          "digest": "${DIGEST}",
          "timestamp_utc": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
        }
        EOF
        
        echo -n "$IMAGE_TAG" > $(results.IMAGE_URL.path)
        echo -n "$DIGEST" > $(results.IMAGE_DIGEST.path)
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
