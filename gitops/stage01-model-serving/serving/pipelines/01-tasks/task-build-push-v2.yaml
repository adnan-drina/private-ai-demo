apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: build-and-push-v2
  namespace: private-ai-demo
  labels:
    app.kubernetes.io/name: modelcar-pipeline
spec:
  description: Build ModelCar image with Buildah (PVC-backed) and push to Quay

  params:
    - name: quay_org
      type: string
    - name: quay_repo
      type: string
    - name: quay_tag
      type: string
    - name: model_path
      type: string
      default: "models"

  workspaces:
    - name: source
    - name: quay-auth
      mountPath: /workspace/quay-auth

  results:
    - name: IMAGE_URL
    - name: IMAGE_DIGEST

  steps:
    - name: build-and-push
      image: registry.redhat.io/rhel9/buildah:latest
      securityContext:
        privileged: true
        capabilities:
          drop:
            - MKNOD
      script: |
        #!/bin/bash
        set -euo pipefail
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ”¨ Build & Push to Quay [$(date -u +%Y-%m-%dT%H:%M:%SZ)]"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Configure Buildah to use PVC for storage (not node ephemeral)
        export HOME=$(workspaces.source.path)/.buildah-home
        export STORAGE_DRIVER=vfs
        install -d -m 2775 -o root -g 1000970000 "$HOME"
        
        echo "ğŸ¯ Build configuration:"
        echo "  Storage driver: vfs (PVC-backed)"
        echo "  Storage root: $HOME"
        echo "  Running as: $(id)"
        echo ""
        
        # Create Containerfile
        MODEL_PATH="$(params.model_path)"
        cat > $(workspaces.source.path)/Containerfile <<EOF
        FROM registry.access.redhat.com/ubi9/ubi-micro:9.5
        COPY ${MODEL_PATH} /models
        USER 1001
        CMD ["/bin/sh"]
        EOF
        
        IMAGE_LOCAL="localhost/$(params.quay_repo):$(params.quay_tag)"
        IMAGE_QUAY="quay.io/$(params.quay_org)/$(params.quay_repo):$(params.quay_tag)"
        
        echo "ğŸš€ Building: $IMAGE_QUAY"
        
        # Build image (privileged mode - no user namespace issues!)
        buildah --storage-driver="${STORAGE_DRIVER}" bud \
          --format oci \
          --layers=false \
          --squash \
          --tag "${IMAGE_LOCAL}" \
          --file $(workspaces.source.path)/Containerfile \
          $(workspaces.source.path)
        
        echo "âœ… Build complete"
        echo ""
        echo "ğŸ“¤ Pushing to Quay..."
        
        # Push directly to Quay (privileged mode - clean and simple!)
        # Note: Secret mounts as .dockerconfigjson (standard k8s format)
        buildah --storage-driver="${STORAGE_DRIVER}" push \
          --authfile /workspace/quay-auth/.dockerconfigjson \
          "${IMAGE_LOCAL}" \
          "docker://${IMAGE_QUAY}"
        
        echo "âœ… Push complete!"
        echo ""
        
        # Get digest and verify
        echo "ğŸ” Verifying pushed image..."
        skopeo inspect --authfile /workspace/quay-auth/.dockerconfigjson \
          "docker://${IMAGE_QUAY}" > $(workspaces.source.path)/.pipeline-metadata/quay-metadata.json
        
        DIGEST=$(jq -r '.Digest' $(workspaces.source.path)/.pipeline-metadata/quay-metadata.json)
        
        echo "   Image:  $IMAGE_QUAY"
        echo "   Digest: $DIGEST"
        echo ""
        
        # Write metadata for downstream tasks
        mkdir -p $(workspaces.source.path)/.pipeline-metadata
        cat > $(workspaces.source.path)/.pipeline-metadata/build-status.json <<EOF
        {
          "image_quay": "${IMAGE_QUAY}",
          "digest": "${DIGEST}",
          "pushed_at_utc": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
        }
        EOF
        
        # Save results
        echo -n "$IMAGE_QUAY" > $(results.IMAGE_URL.path)
        echo -n "$DIGEST" > $(results.IMAGE_DIGEST.path)
        
        echo "âœ… Task complete: Model image built and pushed to Quay"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
