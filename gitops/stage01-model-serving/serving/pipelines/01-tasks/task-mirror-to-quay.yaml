apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: mirror-to-quay
  namespace: private-ai-demo
  labels:
    app.kubernetes.io/name: mirror-to-quay
    app.kubernetes.io/component: pipeline-task
    app.kubernetes.io/part-of: private-ai-demo
  annotations:
    argocd.argoproj.io/sync-wave: "3"
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/tags: "image,registry"
    tekton.dev/displayName: "Mirror Image to Quay.io"
spec:
  description: >-
    This task mirrors a container image from the OpenShift internal registry
    to Quay.io using Skopeo. It handles authentication and image copying.

  params:
    - name: src_image
      type: string
      description: Source image reference (e.g., image-registry.openshift-image-registry.svc:5000/ns/name:tag)
    
    - name: dest_image
      type: string
      description: Destination image reference on Quay (e.g., quay.io/org/name:tag)

  steps:
    - name: mirror-image
      image: registry.redhat.io/rhel9/skopeo:latest
      env:
        - name: QUAY_USERNAME
          valueFrom:
            secretKeyRef:
              name: quay-push
              key: QUAY_USERNAME
        - name: QUAY_PASSWORD
          valueFrom:
            secretKeyRef:
              name: quay-push
              key: QUAY_PASSWORD
      script: |
        #!/bin/bash
        set -euo pipefail
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ”„ Mirroring Image to Quay.io"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Source:      $(params.src_image)"
        echo "Destination: $(params.dest_image)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Login to Quay.io
        echo "ğŸ” Authenticating to Quay.io..."
        skopeo login quay.io \
          --username="${QUAY_USERNAME}" \
          --password="${QUAY_PASSWORD}"
        
        # Copy image with all layers
        echo "ğŸ“¦ Copying image..."
        skopeo copy \
          --all \
          --retry-times=3 \
          --src-tls-verify=false \
          "docker://$(params.src_image)" \
          "docker://$(params.dest_image)"
        
        # Verify the copy (using python json.tool instead of jq to avoid extra dependencies)
        echo "âœ… Verifying image..."
        INSPECT_OUTPUT=$(skopeo inspect "docker://$(params.dest_image)")
        DIGEST=$(echo "$INSPECT_OUTPUT" | python3 -c "import sys, json; print(json.load(sys.stdin).get('Digest', 'N/A'))")
        echo "Image Digest: ${DIGEST}"
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ… Image mirrored successfully to Quay.io"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      securityContext:
        runAsUser: 0

