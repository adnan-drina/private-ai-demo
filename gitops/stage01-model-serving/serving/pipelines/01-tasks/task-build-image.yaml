apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: build-modelcar-image
  namespace: private-ai-demo
  labels:
    app.kubernetes.io/name: build-image
    app.kubernetes.io/component: pipeline-task
    app.kubernetes.io/part-of: private-ai-demo
  annotations:
    argocd.argoproj.io/sync-wave: "3"
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/tags: "image-build,buildah,modelcar"
    tekton.dev/displayName: "Build ModelCar Image"
spec:
  description: >-
    Builds a ModelCar container image from a downloaded model using Buildah.
    This is Task 2 of 3 in the ModelCar pipeline, separated for:
    - Clear visibility of build phase
    - Optimized buildah performance with --layers=false and --squash
    - Reusable model downloads (build multiple times without re-download)
    
    Timeout: 3h to handle large models (48GB full model ~2h, 8GB quantized ~13min)

  timeout: 3h0m0s

  params:
    - name: IMAGE
      type: string
      description: Reference of the image to build (e.g., image-registry.openshift-image-registry.svc:5000/namespace/name:tag)
    
    - name: MODEL_PATH
      type: string
      description: Path to the model files in workspace
      default: "models"
    
    - name: FORMAT
      type: string
      description: Format of the built image (oci or docker)
      default: "oci"
    
    - name: TLSVERIFY
      type: string
      description: Verify TLS on the registry endpoint
      default: "false"

  workspaces:
    - name: source
      description: Workspace containing the downloaded model

  results:
    - name: IMAGE_DIGEST
      description: Digest of the image just built
    
    - name: IMAGE_URL
      description: URL of the image just built
    
    - name: BUILD_TIME
      description: Time taken to build in seconds

  steps:
    - name: create-containerfile
      image: registry.access.redhat.com/ubi9/ubi-minimal:latest
      workingDir: $(workspaces.source.path)
      script: |
        #!/bin/bash
        set -e
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ðŸ“ Creating Containerfile"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Create Containerfile using echo (avoid heredoc in YAML script block)
        echo "FROM registry.access.redhat.com/ubi9/ubi-micro:9.5" > Containerfile
        echo "COPY $(params.MODEL_PATH) /models" >> Containerfile
        echo "USER 1001" >> Containerfile
        echo 'LABEL name="modelcar" vendor="Red Hat" version="1.0"' >> Containerfile
        echo 'CMD ["/bin/sh", "-c", "echo ModelCar ready"]' >> Containerfile
        
        echo "âœ… Containerfile created"
        echo ""
        cat Containerfile

    - name: build-image
      image: registry.redhat.io/rhel9/buildah:latest
      workingDir: $(workspaces.source.path)
      # Increased resources for large model builds (48GB models)
      computeResources:
        requests:
          memory: "8Gi"
          cpu: "4"
        limits:
          memory: "16Gi"
          cpu: "8"
      # Use workspace subdirectory for buildah storage
      env:
        - name: BUILDAH_STORAGE_ROOT
          value: $(workspaces.source.path)/.buildah-storage
        - name: STORAGE_DRIVER
          value: vfs
        - name: TMPDIR
          value: $(workspaces.source.path)/.tmp
        - name: HOME
          value: $(workspaces.source.path)/.home
      script: |
        #!/bin/bash
        set -e
        
        START_TIME=$(date +%s)
        
        # Create buildah directories
        echo "ðŸ“ Setting up buildah storage..."
        mkdir -p ${BUILDAH_STORAGE_ROOT}
        mkdir -p ${TMPDIR}
        mkdir -p ${HOME}
        
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ðŸ”¨ Building ModelCar Image with Buildah"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Context:     $(workspaces.source.path)"
        echo "Dockerfile:  Containerfile"
        echo "Destination: $(params.IMAGE)"
        echo "Format:      $(params.FORMAT)"
        echo "Storage:     ${BUILDAH_STORAGE_ROOT}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ðŸš€ Performance optimizations enabled:"
        echo "  --layers=false   : Skip intermediate layer commits (HUGE speedup!)"
        echo "  --squash         : Single final layer (reduces image size)"
        echo "  --isolation chroot : Faster than default namespace isolation"
        echo "  --ulimit nofile  : Increased file handle limit (8192)"
        echo "  --jobs 4         : Parallel processing where possible"
        echo ""
        echo "â±ï¸  Timeout: 3h (Full model ~2h, Quantized ~13min)"
        echo ""
        
        # Build the image with ALL optimizations (A + B)
        buildah --root ${BUILDAH_STORAGE_ROOT} --storage-driver=vfs bud \
          --format=$(params.FORMAT) \
          --tls-verify=$(params.TLSVERIFY) \
          --no-cache \
          --layers=false \
          --squash \
          --isolation chroot \
          --jobs 4 \
          --ulimit nofile=4096:8192 \
          -f Containerfile \
          -t $(params.IMAGE) \
          .
        
        # Calculate build time
        END_TIME=$(date +%s)
        BUILD_TIME=$((END_TIME - START_TIME))
        
        # Get image digest
        buildah --root ${BUILDAH_STORAGE_ROOT} --storage-driver=vfs images \
          --format '{{.Digest}}' \
          --filter reference=$(params.IMAGE) > /tmp/image-digest
        
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ… Build Complete!"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Image:  $(params.IMAGE)"
        echo "Digest: $(cat /tmp/image-digest)"
        echo "Time:   ${BUILD_TIME}s ($(($BUILD_TIME / 60))m $(($BUILD_TIME % 60))s)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Export to OCI archive on PVC for efficient push
        echo ""
        echo "ðŸ“¦ Exporting to OCI archive (for push tasks)..."
        mkdir -p $(workspaces.source.path)/oci
        buildah --root ${BUILDAH_STORAGE_ROOT} --storage-driver=vfs push \
          $(params.IMAGE) \
          oci-archive:$(workspaces.source.path)/oci/image.tar
        
        echo "âœ… OCI archive created: $(workspaces.source.path)/oci/image.tar"
        
        # Save results
        cat /tmp/image-digest | tee $(results.IMAGE_DIGEST.path)
        echo -n "$(params.IMAGE)" | tee $(results.IMAGE_URL.path)
        echo -n "$BUILD_TIME" > $(results.BUILD_TIME.path)
      
      securityContext:
        capabilities:
          add:
            - SETFCAP

