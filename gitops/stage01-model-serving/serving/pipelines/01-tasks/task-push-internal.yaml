apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: push-to-internal-registry
  namespace: private-ai-demo
  labels:
    app.kubernetes.io/name: push-internal
    app.kubernetes.io/component: pipeline-task
    app.kubernetes.io/part-of: private-ai-demo
  annotations:
    argocd.argoproj.io/sync-wave: "3"
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/tags: "image-push,buildah,registry"
    tekton.dev/displayName: "Push to OpenShift Internal Registry"
spec:
  description: >-
    Pushes ModelCar image from buildah storage to OpenShift internal registry.
    Uses buildah push to transfer image from build task's local storage to registry.
    ServiceAccount token is fresh in this task pod (separate from build task).
    
  params:
    - name: IMAGE
      type: string
      description: Image reference to verify (e.g., image-registry.openshift-image-registry.svc:5000/namespace/name:tag)
    
    - name: TLSVERIFY
      type: string
      description: Verify TLS on the registry endpoint
      default: "false"

  workspaces:
    - name: source
      description: Workspace (not used, kept for pipeline compatibility)
    - name: registry-auth
      description: Docker registry authentication secret
      optional: true

  results:
    - name: IMAGE_DIGEST
      description: Digest of the image in registry
    
    - name: PUSH_TIME
      description: Time taken to verify (kept for compatibility)

  steps:
    - name: push-image
      image: quay.io/buildah/stable:latest
      workingDir: $(workspaces.source.path)
      computeResources:
        requests:
          memory: "1Gi"
          cpu: "500m"
          ephemeral-storage: "100Gi"  # Required for large model pushes (48GB+ images)
        limits:
          memory: "2Gi"
          cpu: "1"
          ephemeral-storage: "150Gi"
      env:
        - name: BUILDAH_STORAGE_ROOT
          value: $(workspaces.source.path)/.buildah-storage
        - name: STORAGE_DRIVER
          value: vfs
      script: |
        #!/bin/bash
        set -e
        
        START_TIME=$(date +%s)
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ðŸ“¤ Pushing Image to OpenShift Internal Registry"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Image: $(params.IMAGE)"
        echo "Storage: ${BUILDAH_STORAGE_ROOT}"
        echo ""
        
        # Get ServiceAccount token (fresh token for this pod)
        TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
        
        # Push image from buildah storage to registry
        echo "ðŸš€ Pushing image from buildah storage..."
        buildah --root ${BUILDAH_STORAGE_ROOT} --storage-driver=${STORAGE_DRIVER} push \
          --creds="serviceaccount:${TOKEN}" \
          --tls-verify=$(params.TLSVERIFY) \
          $(params.IMAGE) \
          docker://$(params.IMAGE)
        
        # Get image digest
        DIGEST=$(buildah --root ${BUILDAH_STORAGE_ROOT} --storage-driver=${STORAGE_DRIVER} images \
          --format '{{.Digest}}' \
          --filter reference=$(params.IMAGE))
        
        if [ -z "$DIGEST" ]; then
          echo "âŒ ERROR: Could not get image digest"
          exit 1
        fi
        
        END_TIME=$(date +%s)
        PUSH_TIME=$((END_TIME - START_TIME))
        
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ… Push Complete!"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Image:  $(params.IMAGE)"
        echo "Digest: $DIGEST"
        echo "Time:   ${PUSH_TIME}s ($(($PUSH_TIME / 60))m $(($PUSH_TIME % 60))s)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Save results
        echo -n "$DIGEST" | tee $(results.IMAGE_DIGEST.path)
        echo -n "$PUSH_TIME" > $(results.PUSH_TIME.path)
      
      securityContext:
        capabilities:
          add:
            - SETFCAP

