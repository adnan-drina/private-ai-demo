apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: push-to-internal-registry
  namespace: private-ai-demo
  labels:
    app.kubernetes.io/name: push-internal
    app.kubernetes.io/component: pipeline-task
    app.kubernetes.io/part-of: private-ai-demo
  annotations:
    argocd.argoproj.io/sync-wave: "3"
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/tags: "image-push,buildah,registry"
    tekton.dev/displayName: "Push to OpenShift Internal Registry"
spec:
  description: >-
    Verifies ModelCar image exists in OpenShift internal registry.
    Image was already pushed during build task to avoid SA token expiration on long builds.
    This task runs in parallel with push-to-quay to provide consistent timing metrics.
    
  params:
    - name: IMAGE
      type: string
      description: Image reference to verify (e.g., image-registry.openshift-image-registry.svc:5000/namespace/name:tag)
    
    - name: TLSVERIFY
      type: string
      description: Verify TLS on the registry endpoint
      default: "false"

  workspaces:
    - name: source
      description: Workspace (not used, kept for pipeline compatibility)
    - name: registry-auth
      description: Docker registry authentication secret
      optional: true

  results:
    - name: IMAGE_DIGEST
      description: Digest of the image in registry
    
    - name: PUSH_TIME
      description: Time taken to verify (kept for compatibility)

  steps:
    - name: verify-image
      image: quay.io/skopeo/stable:latest
      workingDir: /tmp
      computeResources:
        requests:
          memory: "512Mi"
          cpu: "250m"
        limits:
          memory: "1Gi"
          cpu: "500m"
      script: |
        #!/bin/bash
        set -e
        
        START_TIME=$(date +%s)
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ… Verifying Image in OpenShift Internal Registry"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Image: $(params.IMAGE)"
        echo ""
        echo "Note: Image was already pushed during build task to avoid"
        echo "      ServiceAccount token expiration on long builds."
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Get ServiceAccount token
        TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
        
        # Verify image exists and get digest using skopeo
        echo "ðŸ” Inspecting image..."
        INSPECT_OUTPUT=$(skopeo inspect \
          --creds="serviceaccount:${TOKEN}" \
          --tls-verify=$(params.TLSVERIFY) \
          docker://$(params.IMAGE))
        
        # Extract digest without jq (grep and sed) - handle spaces after colon
        DIGEST=$(echo "$INSPECT_OUTPUT" | grep -o '"Digest":[[:space:]]*"sha256:[^"]*"' | head -1 | sed 's/"Digest":[[:space:]]*"//;s/"//')
        
        if [ -z "$DIGEST" ]; then
          echo "âŒ ERROR: Could not get image digest"
          echo "Inspect output: $INSPECT_OUTPUT"
          exit 1
        fi
        
        END_TIME=$(date +%s)
        VERIFY_TIME=$((END_TIME - START_TIME))
        
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ… Image Verified in Internal Registry!"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Image:  $(params.IMAGE)"
        echo "Digest: $DIGEST"
        echo "Time:   ${VERIFY_TIME}s"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Save results
        echo -n "$DIGEST" | tee $(results.IMAGE_DIGEST.path)
        echo -n "$VERIFY_TIME" > $(results.PUSH_TIME.path)

