apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: push-to-internal-registry
  namespace: private-ai-demo
  labels:
    app.kubernetes.io/name: push-internal
    app.kubernetes.io/component: pipeline-task
    app.kubernetes.io/part-of: private-ai-demo
  annotations:
    argocd.argoproj.io/sync-wave: "3"
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/tags: "image-push,buildah,registry"
    tekton.dev/displayName: "Push to OpenShift Internal Registry"
spec:
  description: >-
    Pushes ModelCar image from buildah storage to OpenShift internal registry.
    Uses buildah push to transfer image from build task's local storage to registry.
    ServiceAccount token is fresh in this task pod (separate from build task).
    
  params:
    - name: IMAGE
      type: string
      description: Image reference to verify (e.g., image-registry.openshift-image-registry.svc:5000/namespace/name:tag)
    
    - name: TLSVERIFY
      type: string
      description: Verify TLS on the registry endpoint
      default: "false"

  workspaces:
    - name: source
      description: Workspace (not used, kept for pipeline compatibility)
    - name: registry-auth
      description: Docker registry authentication secret
      optional: true

  results:
    - name: IMAGE_DIGEST
      description: Digest of the image in registry
    
    - name: PUSH_TIME
      description: Time taken to verify (kept for compatibility)

  steps:
    - name: push-image
      image: quay.io/skopeo/stable:latest
      workingDir: $(workspaces.source.path)
      computeResources:
        requests:
          memory: "1Gi"
          cpu: "500m"
        limits:
          memory: "2Gi"
          cpu: "1"
      env:
        - name: TMPDIR
          value: $(workspaces.source.path)/.tmp
        - name: HOME
          value: $(workspaces.source.path)/.home
      script: |
        #!/bin/bash
        set -e
        
        START_TIME=$(date +%s)
        
        # Create temp directories in PVC (not on node ephemeral storage!)
        mkdir -p ${TMPDIR}
        mkdir -p ${HOME}
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ðŸ“¤ Pushing Image to OpenShift Internal Registry"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Source: oci-archive:$(workspaces.source.path)/oci/image.tar"
        echo "Dest:   $(params.IMAGE)"
        echo "Temp Dir: ${TMPDIR} (on PVC)"
        echo ""
        
        # Get ServiceAccount token (fresh token for this pod)
        TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
        
        # Push from OCI archive (on PVC) to registry - NO ephemeral storage needed!
        echo "ðŸš€ Copying from OCI archive to registry..."
        skopeo copy \
          --dest-creds="serviceaccount:${TOKEN}" \
          --dest-tls-verify=$(params.TLSVERIFY) \
          oci-archive:$(workspaces.source.path)/oci/image.tar \
          docker://$(params.IMAGE)
        
        # Get image digest from registry
        DIGEST=$(skopeo inspect \
          --creds="serviceaccount:${TOKEN}" \
          --tls-verify=$(params.TLSVERIFY) \
          docker://$(params.IMAGE) | grep -o '"Digest":[[:space:]]*"sha256:[^"]*"' | sed 's/"Digest":[[:space:]]*"//;s/"//')
        
        if [ -z "$DIGEST" ]; then
          echo "âŒ ERROR: Could not get image digest"
          exit 1
        fi
        
        END_TIME=$(date +%s)
        PUSH_TIME=$((END_TIME - START_TIME))
        
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ… Push Complete!"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Image:  $(params.IMAGE)"
        echo "Digest: $DIGEST"
        echo "Time:   ${PUSH_TIME}s ($(($PUSH_TIME / 60))m $(($PUSH_TIME % 60))s)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Save results
        echo -n "$DIGEST" | tee $(results.IMAGE_DIGEST.path)
        echo -n "$PUSH_TIME" > $(results.PUSH_TIME.path)
      
      securityContext:
        capabilities:
          add:
            - SETFCAP

