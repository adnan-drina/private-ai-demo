apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: push-to-internal-registry
  namespace: private-ai-demo
  labels:
    app.kubernetes.io/name: push-internal
    app.kubernetes.io/component: pipeline-task
    app.kubernetes.io/part-of: private-ai-demo
  annotations:
    argocd.argoproj.io/sync-wave: "3"
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/tags: "image-push,buildah,registry"
    tekton.dev/displayName: "Push to OpenShift Internal Registry"
spec:
  description: >-
    Pushes a built ModelCar image to OpenShift internal registry.
    This is Task 3a of 4 in the ModelCar pipeline (runs in parallel with push-to-quay).
    
  params:
    - name: IMAGE
      type: string
      description: Image reference to push (e.g., image-registry.openshift-image-registry.svc:5000/namespace/name:tag)
    
    - name: TLSVERIFY
      type: string
      description: Verify TLS on the registry endpoint
      default: "false"

  workspaces:
    - name: source
      description: Workspace containing buildah storage
    - name: registry-auth
      description: Docker registry authentication secret
      optional: true

  results:
    - name: IMAGE_DIGEST
      description: Digest of the pushed image
    
    - name: PUSH_TIME
      description: Time taken to push in seconds

  steps:
    - name: push-image
      image: registry.redhat.io/rhel9/buildah:latest
      workingDir: $(workspaces.source.path)
      computeResources:
        requests:
          memory: "4Gi"
          cpu: "1"
        limits:
          memory: "8Gi"
          cpu: "2"
      env:
        - name: BUILDAH_STORAGE_ROOT
          value: $(workspaces.source.path)/.buildah-storage
        - name: STORAGE_DRIVER
          value: vfs
      script: |
        #!/bin/bash
        set -e
        
        START_TIME=$(date +%s)
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ðŸ“¤ Pushing Image to OpenShift Internal Registry"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Image: $(params.IMAGE)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Authenticate using mounted registry secret
        if [ -f "/workspace/registry-auth/.dockerconfigjson" ]; then
          echo "ðŸ” Using registry auth secret"
          export REGISTRY_AUTH_FILE=/workspace/registry-auth/.dockerconfigjson
          
          buildah --root ${BUILDAH_STORAGE_ROOT} --storage-driver=vfs push \
            --authfile ${REGISTRY_AUTH_FILE} \
            --tls-verify=$(params.TLSVERIFY) \
            --digestfile /tmp/image-digest \
            $(params.IMAGE) \
            docker://$(params.IMAGE)
        else
          echo "âš ï¸  No auth secret - using default credentials"
          buildah --root ${BUILDAH_STORAGE_ROOT} --storage-driver=vfs push \
            --tls-verify=$(params.TLSVERIFY) \
            --digestfile /tmp/image-digest \
            $(params.IMAGE) \
            docker://$(params.IMAGE)
        fi
        
        END_TIME=$(date +%s)
        PUSH_TIME=$((END_TIME - START_TIME))
        
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ… Push to Internal Registry Complete!"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Image:  $(params.IMAGE)"
        echo "Digest: $(cat /tmp/image-digest)"
        echo "Time:   ${PUSH_TIME}s"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Save results
        cat /tmp/image-digest | tee $(results.IMAGE_DIGEST.path)
        echo -n "$PUSH_TIME" > $(results.PUSH_TIME.path)
      
      securityContext:
        capabilities:
          add:
            - SETFCAP

