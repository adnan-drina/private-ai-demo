apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: build-runtime-image
  namespace: private-ai-demo
  labels:
    app.kubernetes.io/part-of: model-serving
    pipeline.openshift.io/type: kubernetes
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  description: |
    Builds lightweight runtime image for MinIO-first architecture.
    Image contains only vLLM + dependencies, NO model weights.
    Results in ~5-10GB images instead of 90GB+ ModelCar images.
    
    Runs in UNPRIVILEGED mode (no SCC issues) using fuse-overlayfs.
    
  params:
    - name: model_name
      type: string
      description: "Model name"
    - name: version_name
      type: string
      description: "Version name"
    - name: runtime_tag
      type: string
      description: "Quay image tag (includes date code), e.g., mistral-24b-quantized-w4a16-2501"
    - name: quay_org
      type: string
      description: "Quay.io organization"
    - name: quay_repo
      type: string
      description: "Quay.io repository (e.g., private-ai)"
    - name: base_image
      type: string
      default: "registry.access.redhat.com/ubi9/python-311:latest"
      description: "Base image for runtime"
    - name: vllm_version
      type: string
      default: "0.6.0"
      description: "vLLM version to install"
  
  workspaces:
    - name: workspace
      description: "PVC workspace"
    - name: quay-auth
      description: "Workspace carrying dockerconfigjson for registry auth"
  
  steps:
    - name: build-runtime
      image: registry.redhat.io/rhel9/buildah:latest
      imagePullPolicy: IfNotPresent
      
      # Run as non-root user (no privileged mode needed!)
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        capabilities:
          add:
            - SETFCAP  # Required for fuse-overlayfs
      
      env:
        - name: MODEL_NAME
          value: "$(params.model_name)"
        - name: VERSION_NAME
          value: "$(params.version_name)"
        - name: RUNTIME_TAG
          value: "$(params.runtime_tag)"
        - name: QUAY_ORG
          value: "$(params.quay_org)"
        - name: QUAY_REPO
          value: "$(params.quay_repo)"
        - name: BASE_IMAGE
          value: "$(params.base_image)"
        - name: VLLM_VERSION
          value: "$(params.vllm_version)"
        
        # Buildah storage configuration for unprivileged mode
        - name: STORAGE_DRIVER
          value: "vfs"  # Most compatible, no fuse required
        - name: BUILDAH_FORMAT
          value: "oci"
        - name: BUILDAH_ISOLATION
          value: "chroot"
      
      script: |
        #!/bin/bash
        set -euo pipefail
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ðŸ—ï¸  BUILD LIGHTWEIGHT RUNTIME IMAGE (UNPRIVILEGED)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
        echo "Model: ${MODEL_NAME}"
        echo "Version: ${VERSION_NAME}"
        echo "Runtime Tag: ${RUNTIME_TAG}"
        echo "Pattern: MinIO-first (Runtime Only - NO weights)"
        echo "Security: Unprivileged (no SCC issues)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        # Setup storage directories in workspace PVC
        echo "ðŸ”§ Setting up buildah storage (unprivileged)..."
        export BUILDAH_STORAGE_ROOT="$(workspaces.workspace.path)/buildah-storage"
        export BUILDAH_RUNROOT="$(workspaces.workspace.path)/buildah-runroot"
        export TMPDIR="$(workspaces.workspace.path)/tmp"
        
        mkdir -p "${BUILDAH_STORAGE_ROOT}" "${BUILDAH_RUNROOT}" "${TMPDIR}"
        
        # Configure storage for unprivileged mode
        mkdir -p ~/.config/containers
        cat > ~/.config/containers/storage.conf <<'STORAGE_EOF'
        [storage]
        driver = "vfs"
        runroot = "${BUILDAH_RUNROOT}"
        graphroot = "${BUILDAH_STORAGE_ROOT}"
        
        [storage.options]
        size = ""
        
        [storage.options.vfs]
        ignore_chown_errors = "true"
        STORAGE_EOF
        
        echo "âœ… Storage configured (driver: vfs, unprivileged)"
        echo ""
        
        # Configure Quay auth from workspace
        echo "ðŸ” Setting up Quay authentication..."
        if [ -f "$(workspaces.quay-auth.path)/.dockerconfigjson" ]; then
          mkdir -p ~/.docker
          cp "$(workspaces.quay-auth.path)/.dockerconfigjson" ~/.docker/config.json
          echo "âœ… Quay auth configured from workspace"
        else
          echo "âš ï¸  No Quay auth found in workspace, will try login"
        fi
        echo ""
        
        # Define image names
        IMAGE_NAME="${QUAY_REPO}"
        IMAGE_TAG="${RUNTIME_TAG}"
        QUAY_IMAGE="quay.io/${QUAY_ORG}/${IMAGE_NAME}:${IMAGE_TAG}"
        
        echo "ðŸ“¦ Target image: ${QUAY_IMAGE}"
        echo ""
        
        # Read MinIO metadata from upload task
        echo "ðŸ“‹ Reading MinIO metadata from previous task..."
        if [ -f "$(workspaces.workspace.path)/metadata/minio-upload.json" ]; then
          cat "$(workspaces.workspace.path)/metadata/minio-upload.json"
          echo ""
        else
          echo "âš ï¸  No MinIO metadata found (expected from upload-to-minio task)"
        fi
        echo ""
        
        # Create Containerfile for runtime
        echo "ðŸ“ Creating Containerfile..."
        CONTAINERFILE_PATH="$(workspaces.workspace.path)/Containerfile.runtime"
        
        cat > "${CONTAINERFILE_PATH}" <<'CONTAINERFILE_EOF'
        # Lightweight vLLM Runtime Image (MinIO-first - NO model weights)
        ARG BASE_IMAGE
        FROM ${BASE_IMAGE}
        
        # Install system dependencies
        USER root
        RUN dnf install -y \
            git \
            wget \
            gcc \
            gcc-c++ \
            make \
            && dnf clean all
        
        # Install Python dependencies
        ARG VLLM_VERSION
        RUN pip install --no-cache-dir \
            vllm==${VLLM_VERSION} \
            huggingface-hub \
            boto3 \
            && pip cache purge
        
        # Install MinIO client for model fetching
        RUN wget https://dl.min.io/client/mc/release/linux-amd64/mc \
            -O /usr/local/bin/mc && \
            chmod +x /usr/local/bin/mc
        
        # Create app directory
        WORKDIR /app
        
        # Model cache directory (will be mounted PVC or fetched from MinIO)
        RUN mkdir -p /model-cache && \
            chown -R 1001:0 /model-cache && \
            chmod -R g+rwX /model-cache
        
        USER 1001
        
        # Default command (overridden by InferenceService)
        CMD ["python", "-m", "vllm.entrypoints.openai.api_server", "--host", "0.0.0.0", "--port", "8080"]
        
        LABEL io.openshift.tags="vllm,llm,inference,minio" \
              summary="vLLM Runtime for MinIO-backed models" \
              description="Lightweight runtime image for vLLM inference with MinIO object storage backend"
        CONTAINERFILE_EOF
        
        echo "âœ… Containerfile created"
        echo ""
        
        # Build runtime image (unprivileged!)
        echo "ðŸ—ï¸  Building runtime image (unprivileged)..."
        buildah bud \
          --format=oci \
          --isolation=chroot \
          --build-arg BASE_IMAGE="${BASE_IMAGE}" \
          --build-arg VLLM_VERSION="${VLLM_VERSION}" \
          --file="${CONTAINERFILE_PATH}" \
          --tag "${QUAY_IMAGE}" \
          --layers=true \
          "$(workspaces.workspace.path)"
        
        echo "âœ… Runtime image built"
        echo ""
        
        # Get image size
        IMAGE_SIZE=$(buildah images --format "{{.Size}}" "${QUAY_IMAGE}" || echo "unknown")
        echo "ðŸ“ Runtime image size: ${IMAGE_SIZE}"
        echo ""
        
        # Push to Quay
        echo "â¬†ï¸  Pushing to Quay.io..."
        buildah push "${QUAY_IMAGE}"
        
        echo "âœ… Pushed to Quay.io"
        echo ""
        
        # Write metadata
        echo "ðŸ“ Writing metadata..."
        METADATA_DIR="$(workspaces.workspace.path)/metadata"
        mkdir -p "${METADATA_DIR}"
        
        cat > "${METADATA_DIR}/runtime-image.json" <<METADATA_EOF
        {
          "model_name": "${MODEL_NAME}",
          "version_name": "${VERSION_NAME}",
          "runtime_tag": "${RUNTIME_TAG}",
          "runtime_image": "${QUAY_IMAGE}",
          "image_size": "${IMAGE_SIZE}",
          "pattern": "minio-first",
          "vllm_version": "${VLLM_VERSION}",
          "build_timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "unprivileged": true
        }
        METADATA_EOF
        
        echo "âœ… Metadata written"
        cat "${METADATA_DIR}/runtime-image.json"
        echo ""
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ… RUNTIME IMAGE BUILD COMPLETE (UNPRIVILEGED)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Image: ${QUAY_IMAGE}"
        echo "Size: ${IMAGE_SIZE}"
        echo "Pattern: MinIO-first (Runtime + MinIO weights)"
        echo "Security: Unprivileged (no SCC violations)"
        echo "Next: register-model task"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      computeResources:
        requests:
          memory: "4Gi"
          cpu: "2"
          ephemeral-storage: "20Gi"
        limits:
          memory: "8Gi"
          cpu: "4"
          ephemeral-storage: "80Gi"

