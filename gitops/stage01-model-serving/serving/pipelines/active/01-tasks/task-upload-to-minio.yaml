apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: upload-to-minio
  namespace: private-ai-demo
  labels:
    app.kubernetes.io/part-of: model-serving
    pipeline.openshift.io/type: kubernetes
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  description: |
    Uploads model weights to MinIO object storage.
    This task enables Path B architecture: lightweight runtime + weights in object storage.
    
  params:
    - name: model_name
      type: string
      description: "Model name (e.g., Mistral-Small-24B-Instruct)"
    - name: version_name
      type: string
      description: "Version name (e.g., full-fp16-2501)"
    - name: minio_endpoint
      type: string
      default: "http://minio.model-storage.svc:9000"
      description: "MinIO S3 endpoint"
    - name: minio_bucket
      type: string
      default: "llm-models"
      description: "MinIO bucket name"
  
  workspaces:
    - name: workspace
      description: "PVC workspace containing downloaded model"
  
  steps:
    - name: upload-to-minio
      image: quay.io/minio/mc:RELEASE.2024-10-08T09-37-26Z
      imagePullPolicy: IfNotPresent
      
      env:
        - name: MINIO_ENDPOINT
          value: "$(params.minio_endpoint)"
        - name: MINIO_BUCKET
          value: "$(params.minio_bucket)"
        - name: MODEL_NAME
          value: "$(params.model_name)"
        - name: VERSION_NAME
          value: "$(params.version_name)"
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: accesskey
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secretkey
        - name: MC_CONFIG_DIR
          value: "/tmp/.mc"
      
      script: |
        #!/bin/bash
        set -euo pipefail
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ðŸ“¤ UPLOAD MODEL TO MINIO"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
        echo "Model: ${MODEL_NAME}"
        echo "Version: ${VERSION_NAME}"
        echo "Endpoint: ${MINIO_ENDPOINT}"
        echo "Bucket: ${MINIO_BUCKET}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        # Configure MinIO client
        echo "ðŸ”§ Configuring MinIO client..."
        mc alias set minio "${MINIO_ENDPOINT}" "${MINIO_ACCESS_KEY}" "${MINIO_SECRET_KEY}"
        echo "âœ… MinIO client configured"
        echo ""
        
        # Verify bucket exists
        echo "ðŸ“¦ Verifying bucket '${MINIO_BUCKET}' exists..."
        if ! mc ls minio/${MINIO_BUCKET} >/dev/null 2>&1; then
          echo "   Creating bucket..."
          mc mb minio/${MINIO_BUCKET}
        fi
        echo "âœ… Bucket verified"
        echo ""
        
        # Define S3 path
        S3_PREFIX="${MODEL_NAME}/${VERSION_NAME}"
        echo "ðŸ“‚ Target S3 path: s3://${MINIO_BUCKET}/${S3_PREFIX}/"
        echo ""
        
        # Debug: Check workspace structure
        echo "ðŸ” DEBUG: Workspace filesystem structure:"
        echo "Root /workspace/:"
        ls -la /workspace/ || true
        echo ""
        echo "Workspace subdirs:"
        find /workspace/ -maxdepth 2 -type d || true
        echo ""
        
        # Find model directory
        # Download task uses workspace "source" and writes to target_path "models"
        # Upload task uses workspace "workspace", so same PVC root is at /workspace/workspace/
        if [ -d "/workspace/workspace/models" ]; then
          MODEL_DIR="/workspace/workspace/models"
        elif [ -d "/workspace/models" ]; then
          MODEL_DIR="/workspace/models"
        else
          echo "âŒ ERROR: Model directory not found in expected locations"
          echo "   Tried: /workspace/workspace/models, /workspace/models"
          exit 1
        fi
        
        echo "âœ… Found model directory: ${MODEL_DIR}"
        echo ""
        
        # Display model contents
        echo "ðŸ“Š Model directory contents:"
        ls -lh "${MODEL_DIR}" | head -20
        echo ""
        
        # Calculate total size
        TOTAL_SIZE=$(du -sh "${MODEL_DIR}" | cut -f1)
        echo "ðŸ“ Total model size: ${TOTAL_SIZE}"
        echo ""
        
        # Upload to MinIO
        echo "â¬†ï¸  Uploading to MinIO..."
        echo "   This may take several minutes for large models..."
        START_TIME=$(date +%s)
        
        # Upload files (mc cp is verbose by default, no need for grep)
        mc cp --recursive "${MODEL_DIR}/" "minio/${MINIO_BUCKET}/${S3_PREFIX}/"
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo ""
        echo "âœ… Upload complete in ${DURATION} seconds"
        echo ""
        
        # Verify upload
        echo "ðŸ” Verifying upload..."
        echo "Uploaded files (first 10):"
        mc ls --recursive "minio/${MINIO_BUCKET}/${S3_PREFIX}/" | head -10 || echo "  Unable to list files"
        echo "âœ… Upload verification complete"
        echo ""
        
        # Write metadata for next tasks
        echo "ðŸ“ Writing metadata for downstream tasks..."
        mkdir -p /workspace/metadata
        
        cat > /workspace/metadata/minio-upload.json <<METADATA_EOF
        {
          "model_name": "${MODEL_NAME}",
          "version_name": "${VERSION_NAME}",
          "minio_endpoint": "${MINIO_ENDPOINT}",
          "minio_bucket": "${MINIO_BUCKET}",
          "s3_prefix": "${S3_PREFIX}",
          "s3_uri": "s3://${MINIO_BUCKET}/${S3_PREFIX}/",
          "upload_timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "upload_duration_seconds": ${DURATION},
          "total_size": "${TOTAL_SIZE}",
          "file_count": ${UPLOADED_COUNT},
          "pattern": "minio"
        }
        METADATA_EOF
        
        echo "âœ… Metadata written to /workspace/metadata/minio-upload.json"
        echo ""
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ… UPLOAD TO MINIO COMPLETE"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "S3 URI: s3://${MINIO_BUCKET}/${S3_PREFIX}/"
        echo "Endpoint: ${MINIO_ENDPOINT}"
        echo "Pattern: Runtime + Mounted Weights (Path B)"
        echo "Next: build-runtime-image task"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      computeResources:
        requests:
          memory: "512Mi"
          cpu: "500m"
        limits:
          memory: "1Gi"
          cpu: "1"

