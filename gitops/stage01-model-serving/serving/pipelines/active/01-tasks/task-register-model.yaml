apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: register-model
  namespace: private-ai-demo
  labels:
    app.kubernetes.io/name: register-model
    app.kubernetes.io/component: pipeline-task
    app.kubernetes.io/part-of: private-ai-demo
  annotations:
    argocd.argoproj.io/sync-wave: "3"
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/tags: "model-registry,mlops"
    tekton.dev/displayName: "Register Model in Model Registry"
spec:
  description: >-
    This task registers a model in the OpenShift AI Model Registry using the
    Python SDK. For the MinIO-first architecture, it records a lightweight
    runtime image (OCI) and the model weights location (S3/MinIO) in metadata.

  params:
    - name: model_name
      type: string
      description: Name of the registered model (e.g., "Mistral-24B-Instruct")
    
    - name: version_name
      type: string
      description: Version identifier (e.g., "quantized-2501", "full-2501")
    
    - name: image_uri
      type: string
      description: OCI image URI (e.g., "oci://quay.io/org/model:tag")
    
    - name: model_format_name
      type: string
      description: Model format name
      default: "WeightsInS3"
    
    - name: model_format_version
      type: string
      description: Model format version
      default: "1"
    
    - name: description
      type: string
      description: Model version description
      default: ""
    
    - name: base_model
      type: string
      description: Base model name (e.g., "mistralai/Mistral-Large-Instruct-2407")
      default: ""
    
    - name: quantization
      type: string
      description: Quantization type (e.g., "w4a16", "fp16", "none")
      default: "none"
    
    - name: gpu_requirement
      type: string
      description: Number of GPUs required
      default: "1"
    
    - name: minio_bucket
      type: string
      description: Default MinIO bucket to construct S3 URI when metadata file is absent
      default: "llm-models"

  workspaces:
    - name: workspace
      description: Shared workspace for metadata exchange between tasks

  steps:
    - name: register-via-sdk
      image: registry.access.redhat.com/ubi9/python-311:latest
      computeResources:
        requests:
          memory: "512Mi"
          cpu: "250m"
        limits:
          memory: "1Gi"
          cpu: "500m"
      env:
        - name: MODEL_REGISTRY_HOST
          value: "private-ai-model-registry.rhoai-model-registries.svc.cluster.local"
      script: |
        #!/usr/bin/env bash
        set -euo pipefail
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“ [$(date -u +%Y-%m-%dT%H:%M:%SZ)] Register Model"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Runtime context
        echo "ğŸ” DEBUG: Runtime context"
        echo "  Task: register-model"
        echo "  Time (UTC): $(date -u +%Y-%m-%dT%H:%M:%SZ)"
        echo "  Node: $(cat /etc/hostname)"
        echo ""
        
        # Install Python SDK
        echo "ğŸ“¦ Installing model-registry Python SDK..."
        pip install --quiet model-registry==0.2.10
        
        # Run Python script using SDK
        python3 << 'EOFPYTHON'
        import os
        import sys
        from model_registry import ModelRegistry
        from datetime import datetime
        import json

        print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
        print(f"ğŸ“ [{datetime.utcnow().isoformat()}Z] Registering Model (Python SDK)")
        print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")

        # Get parameters
        model_name = "$(params.model_name)"
        version_name = "$(params.version_name)"
        image_uri = "$(params.image_uri)"
        format_name = "$(params.model_format_name)"
        format_version = "$(params.model_format_version)"
        description = "$(params.description)" or f"Runtime + S3 weights for {model_name}"
        base_model = "$(params.base_model)"
        quantization = "$(params.quantization)"
        gpu_requirement = "$(params.gpu_requirement)"

        print("\nğŸ¯ Registration parameters:")
        print(f"  Model Name:        {model_name}")
        print(f"  Version:           {version_name}")
        print(f"  Base Model:        {base_model}")
        print(f"  Quantization:      {quantization}")
        print(f"  GPU Requirement:   {gpu_requirement}")
        print(f"  Runtime Image:     {image_uri}")
        print(f"  Format:            {format_name} v{format_version}")
        print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")

        # Attempt to read MinIO metadata written by previous task
        s3_uri = None
        metadata_path_candidates = [
            "$(workspaces.workspace.path)/metadata/minio-upload.json",
            "/workspace/workspace/metadata/minio-upload.json",
        ]
        for p in metadata_path_candidates:
            try:
                with open(p, "r") as f:
                    data = json.load(f)
                    s3_uri = data.get("s3_uri")
                    minio_endpoint = data.get("minio_endpoint")
                    minio_bucket = data.get("minio_bucket")
                    s3_prefix = data.get("s3_prefix")
                    break
            except Exception:
                continue

        runtime_image_digest = None
        runtime_meta_candidates = [
            "$(workspaces.workspace.path)/metadata/runtime-image.json",
            "/workspace/workspace/metadata/runtime-image.json",
        ]
        for p in runtime_meta_candidates:
            try:
                with open(p, "r") as f:
                    r = json.load(f)
                    runtime_image_digest = r.get("runtime_image_digest")
                    break
            except Exception:
                continue

        # If no s3_uri discovered, compute it based on params and default bucket
        if not s3_uri:
            bucket = "$(params.minio_bucket)"
            s3_uri = f"s3://{bucket}/{model_name}/{version_name}/"

        # Get Model Registry host
        registry_host = os.environ.get("MODEL_REGISTRY_HOST", "private-ai-model-registry.rhoai-model-registries.svc.cluster.local")
        
        print(f"\nğŸ”— Registry Host: {registry_host}")

        try:
            # Initialize SDK
            print("\nğŸ”Œ Connecting to Model Registry...")
            registry = ModelRegistry(
                server_address=f"http://{registry_host}",
                port=8080,
                author="GitOps-Pipeline",
                is_secure=False  # HTTP connection, no authentication needed
            )
            
            print("âœ… Connected successfully!")
            
            # Register model with SDK and rich metadata
            print(f"\nğŸ“ Registering model: {model_name} version {version_name}...")
            
            # Build metadata dictionary
            metadata = {
                "pipeline": "PathB-MinIO",
                "runtime_image": image_uri,
                "format": format_name,
                "deployment_type": "vLLM",
                "use_case": "inference",
            }
            # Only include digest if present; some registry SDKs reject nulls
            if runtime_image_digest:
                metadata["runtime_image_digest"] = runtime_image_digest
            
            if s3_uri:
                metadata["artifact_uri"] = s3_uri
                # Best-effort enrichments if we had them from file
                if 'minio_endpoint' in locals():
                    metadata["minio_endpoint"] = minio_endpoint
                if 'minio_bucket' in locals():
                    metadata["minio_bucket"] = minio_bucket
                if 's3_prefix' in locals():
                    metadata["s3_prefix"] = s3_prefix

            # Add optional metadata if provided
            if base_model:
                metadata["base_model"] = base_model
                metadata["source"] = "HuggingFace"
            
            if quantization and quantization != "none":
                metadata["quantization"] = quantization
                metadata["optimization"] = "AWQ" if "w4" in quantization.lower() else "None"
            
            if gpu_requirement:
                metadata["gpu_requirement"] = gpu_requirement
                metadata["accelerator"] = "NVIDIA-GPU"
            
            print(f"\nğŸ“‹ Metadata: {metadata}")
            
            # Location URI policy (Path B): use S3 as primary location when available
            location_uri = s3_uri or image_uri

            try:
                registered_model = registry.register_model(
                    name=model_name,
                    uri=location_uri,
                    model_format_name=format_name,
                    model_format_version=format_version,
                    version=version_name,
                    description=description,
                    metadata=metadata
                )

                print(f"\nâœ… Model registered successfully! [{datetime.utcnow().isoformat()}Z]")
                # Some SDKs return dict-like, others objects; print best-effort fields
                rm_id = getattr(registered_model, "id", None) or getattr(registered_model, "model_id", None) or "<unknown>"
                rm_name = getattr(registered_model, "name", None) or model_name
                print(f"   Registered Model ID: {rm_id}")
                print(f"   Model Name: {rm_name}")
                print(f"   Version: {version_name}")

                # Single-line machine-readable summary (for easy grepping)
                print(f'\nTASK3_SUMMARY {{"stage":"registered","model":"{model_name}","version":"{version_name}","runtime_image":"{image_uri}","runtime_image_digest":"{runtime_image_digest}","artifact_uri":"{s3_uri}","time_utc":"{datetime.utcnow().isoformat()}Z"}}')

            except Exception as register_err:
                err_msg = str(register_err)
                if "already exists" in err_msg.lower():
                    print(f"\nâ„¹ï¸  Version already exists; attempting metadata update. [{datetime.utcnow().isoformat()}Z]")
                    updated = False
                    update_error = None
                    # Try common update methods exposed by the SDK across versions
                    try:
                        # Most-capable: update core fields + metadata
                        registry.update_model_version(
                            name=model_name,
                            version=version_name,
                            uri=location_uri,
                            description=description,
                            metadata=metadata,
                        )
                        updated = True
                    except Exception as up_err1:
                        update_error = up_err1
                        try:
                            # Fallback: metadata-only update
                            registry.update_model_version_metadata(
                                name=model_name,
                                version=version_name,
                                metadata=metadata,
                            )
                            updated = True
                        except Exception as up_err2:
                            update_error = up_err2

                    if updated:
                        print(f"âœ… Updated existing model version metadata. [{datetime.utcnow().isoformat()}Z]")
                        print(f"   Model: {model_name}")
                        print(f"   Version: {version_name}")
                        print(
                            f'\nTASK3_SUMMARY {{"stage":"updated","model":"{model_name}","version":"{version_name}","runtime_image":"{image_uri}","runtime_image_digest":"{runtime_image_digest}","artifact_uri":"{s3_uri}","time_utc":"{datetime.utcnow().isoformat()}Z"}}'
                        )
                    else:
                        # Attempt delete-and-recreate with same version to set new Location
                        try:
                            print(f"âš ï¸  Update API unavailable. Attempting delete-and-recreate for version '{version_name}'.")
                            # Try common delete method names
                            deleted = False
                            try:
                                registry.delete_model_version(name=model_name, version=version_name)
                                deleted = True
                            except Exception:
                                try:
                                    registry.delete_version(name=model_name, version=version_name)
                                    deleted = True
                                except Exception:
                                    pass

                            if deleted:
                                print("ğŸ§¹ Deleted existing version. Re-registering with S3 Location...")
                                registered_model = registry.register_model(
                                    name=model_name,
                                    uri=location_uri,
                                    model_format_name=format_name,
                                    model_format_version=format_version,
                                    version=version_name,
                                    description=description,
                                    metadata=metadata
                                )
                                print("âœ… Re-registered version with S3 Location.")
                                print(
                                    f'\nTASK3_SUMMARY {{"stage":"recreated","model":"{model_name}","version":"{version_name}","runtime_image":"{image_uri}","runtime_image_digest":"{runtime_image_digest}","artifact_uri":"{s3_uri}","time_utc":"{datetime.utcnow().isoformat()}Z"}}'
                                )
                            else:
                                # Fall back to exists if neither update nor delete is supported
                                print(
                                    f"âš ï¸  Update/Delete APIs not available. Proceeding as already-registered.",
                                    file=sys.stderr,
                                )
                                print(
                                    f'\nTASK3_SUMMARY {{"stage":"exists","model":"{model_name}","version":"{version_name}","runtime_image":"{image_uri}","runtime_image_digest":"{runtime_image_digest}","artifact_uri":"{s3_uri}","time_utc":"{datetime.utcnow().isoformat()}Z"}}'
                                )
                        except Exception as recreate_err:
                            # If delete/recreate itself fails, acknowledge existing entry
                            print(
                                f"âš ï¸  Delete/Recreate failed ({type(recreate_err).__name__}: {str(recreate_err)}). Proceeding as already-registered.",
                                file=sys.stderr,
                            )
                            print(
                                f'\nTASK3_SUMMARY {{"stage":"exists","model":"{model_name}","version":"{version_name}","runtime_image":"{image_uri}","runtime_image_digest":"{runtime_image_digest}","artifact_uri":"{s3_uri}","time_utc":"{datetime.utcnow().isoformat()}Z"}}'
                            )
                else:
                    raise
            
            print("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
            print("âœ… Task 3 Complete: Model registered in Model Registry")
            print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
            
        except Exception as e:
            print(f"\nâŒ ERROR: Registration failed [{datetime.utcnow().isoformat()}Z]", file=sys.stderr)
            print(f"Error: {str(e)}", file=sys.stderr)
            import traceback
            traceback.print_exc(file=sys.stderr)
            sys.exit(1)

        EOFPYTHON
        
        # Final PIPELINE_SUMMARY (comprehensive success receipt)
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "PIPELINE_SUMMARY {\"pipeline\":\"model-import-minio\",\"status\":\"success\",\"model\":\"$(params.model_name)\",\"version\":\"$(params.version_name)\",\"runtime_image\":\"$(params.image_uri)\",\"base_model\":\"$(params.base_model)\",\"quantization\":\"$(params.quantization)\",\"gpu_requirement\":\"$(params.gpu_requirement)\",\"time_utc\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ‰ PIPELINE COMPLETE ğŸ‰"
        echo ""
        echo "âœ… All tasks succeeded:"
        echo "   1. Model downloaded from HuggingFace"
        echo "   2. Runtime image built and pushed to Quay"
        echo "   3. Weights uploaded to MinIO and recorded in metadata"
        echo "   4. Model registered in Model Registry (runtime + artifact URI)"
        echo ""
        echo "ğŸš€ Model is now ready for deployment!"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
