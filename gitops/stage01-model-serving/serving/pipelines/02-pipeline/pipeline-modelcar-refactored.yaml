apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: modelcar-build-deploy-v2
  namespace: private-ai-demo
  labels:
    app.kubernetes.io/name: modelcar-pipeline
    app.kubernetes.io/component: pipeline
    app.kubernetes.io/part-of: private-ai-demo
    app.kubernetes.io/version: "2.0"
  annotations:
    argocd.argoproj.io/sync-wave: "4"
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/tags: "mlops,modelcar,vllm"
    tekton.dev/displayName: "ModelCar Build and Deploy Pipeline v2 (Refactored)"
spec:
  description: >-
    Refactored ModelCar pipeline with 4 separate tasks for better visibility and reusability:
    1. download-model: Downloads model from HuggingFace to workspace PVC (~12min)
    2. build-image: Builds ModelCar container with optimizations (~5-10min for quantized, ~2h for full)
    3a. push-to-internal: Pushes to OpenShift registry (parallel, ~3-5min)
    3b. push-to-quay: Pushes to Quay.io (parallel, ~3-5min)
    4. register-model: Registers in Model Registry (after both pushes complete)
    
    Benefits:
    - Better visibility (see which phase is running)
    - Faster retries (skip download if model exists)
    - Easier debugging (clear failure points)
    - Parallel pushes (faster overall time)
    - Reusable downloads (multiple builds from same download)
    
    Timeout: 4h total (download 30min + build 3h + push 30min)

  timeout: 4h0m0s

  params:
    # Model source parameters
    - name: hf_repo
      type: string
      description: HuggingFace repository ID
    
    - name: hf_revision
      type: string
      description: HuggingFace revision to download
      default: "main"
    
    # Image and registry parameters
    - name: image_stream_name
      type: string
      description: Name of the ImageStream in OpenShift
    
    - name: image_tag
      type: string
      description: Tag for the built image
      default: "latest"
    
    - name: quay_org
      type: string
      description: Quay.io organization name
    
    - name: quay_repo
      type: string
      description: Quay.io repository name
    
    - name: quay_tag
      type: string
      description: Tag for Quay image
      default: "latest"
    
    # Model Registry parameters
    - name: model_name
      type: string
      description: Registered model name in Model Registry
    
    - name: version_name
      type: string
      description: Model version identifier
    
    - name: version_description
      type: string
      description: Description for this model version
      default: ""
    
    - name: base_model
      type: string
      description: Base model HuggingFace ID (for metadata)
      default: ""
    
    - name: quantization
      type: string
      description: Quantization type (e.g., w4a16, fp16, none)
      default: "none"
    
    - name: gpu_requirement
      type: string
      description: Number of GPUs required for deployment
      default: "1"
    
    # Internal parameters
    - name: internal_registry
      type: string
      description: OpenShift internal registry hostname
      default: "image-registry.openshift-image-registry.svc:5000"
    
    - name: namespace
      type: string
      description: Target namespace
      default: "private-ai-demo"

  workspaces:
    - name: shared-workspace
      description: Shared workspace for model download, build, and push
    - name: registry-auth
      description: OpenShift internal registry authentication
      optional: true
    - name: quay-auth
      description: Quay.io authentication secret
      optional: true

  tasks:
    # Task 1: Download model from HuggingFace
    - name: download-model
      timeout: "5m"  # TEST: Short timeout to verify configuration works
      taskRef:
        name: download-model-from-hf
        kind: Task
      params:
        - name: hf_repo
          value: $(params.hf_repo)
        - name: hf_revision
          value: $(params.hf_revision)
        - name: target_path
          value: "models"
      workspaces:
        - name: source
          workspace: shared-workspace
    
    # Task 2: Build ModelCar image
    - name: build-image
      timeout: "3h"
      runAfter: ["download-model"]
      taskRef:
        name: build-modelcar-image
        kind: Task
      params:
        - name: IMAGE
          value: $(params.internal_registry)/$(params.namespace)/$(params.image_stream_name):$(params.image_tag)
        - name: MODEL_PATH
          value: "models"
        - name: FORMAT
          value: "oci"
        - name: TLSVERIFY
          value: "false"
      workspaces:
        - name: source
          workspace: shared-workspace
    
    # Task 3a: Push to OpenShift internal registry (parallel)
    - name: push-to-internal
      timeout: "30m"
      runAfter: ["build-image"]
      taskRef:
        name: push-to-internal-registry
        kind: Task
      params:
        - name: IMAGE
          value: $(params.internal_registry)/$(params.namespace)/$(params.image_stream_name):$(params.image_tag)
        - name: TLSVERIFY
          value: "false"
      workspaces:
        - name: source
          workspace: shared-workspace
        - name: registry-auth
          workspace: registry-auth
    
    # Task 3b: Push to Quay.io (parallel with push-to-internal)
    - name: push-to-quay
      timeout: "30m"
      runAfter: ["build-image"]
      taskRef:
        name: push-to-quay
        kind: Task
      params:
        - name: SOURCE_IMAGE
          value: $(params.internal_registry)/$(params.namespace)/$(params.image_stream_name):$(params.image_tag)
        - name: QUAY_ORG
          value: $(params.quay_org)
        - name: QUAY_REPO
          value: $(params.quay_repo)
        - name: QUAY_TAG
          value: $(params.quay_tag)
        - name: TLSVERIFY
          value: "true"
      workspaces:
        - name: source
          workspace: shared-workspace
        - name: quay-auth
          workspace: quay-auth
    
    # Task 4: Register model (after both pushes complete)
    - name: register-model
      timeout: "15m"
      runAfter: ["push-to-internal", "push-to-quay"]
      taskRef:
        name: register-model
        kind: Task
      params:
        - name: model_name
          value: $(params.model_name)
        - name: version_name
          value: $(params.version_name)
        - name: image_uri
          value: "oci://quay.io/$(params.quay_org)/$(params.quay_repo):$(params.quay_tag)"
        - name: model_format_name
          value: "ModelCar"
        - name: model_format_version
          value: "1"
        - name: description
          value: $(params.version_description)
        - name: base_model
          value: $(params.base_model)
        - name: quantization
          value: $(params.quantization)
        - name: gpu_requirement
          value: $(params.gpu_requirement)

  results:
    - name: download-time
      description: Time taken to download model
      value: $(tasks.download-model.results.DOWNLOAD_TIME)
    
    - name: build-time
      description: Time taken to build image
      value: $(tasks.build-image.results.BUILD_TIME)
    
    - name: push-internal-time
      description: Time taken to push to internal registry
      value: $(tasks.push-to-internal.results.PUSH_TIME)
    
    - name: push-quay-time
      description: Time taken to push to Quay
      value: $(tasks.push-to-quay.results.PUSH_TIME)
    
    - name: image-digest
      description: Digest of the built image
      value: $(tasks.build-image.results.IMAGE_DIGEST)
    
    - name: quay-image-url
      description: Full Quay.io image URL
      value: $(tasks.push-to-quay.results.IMAGE_URL)

