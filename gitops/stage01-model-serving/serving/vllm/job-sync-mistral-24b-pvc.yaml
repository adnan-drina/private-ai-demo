---
apiVersion: batch/v1
kind: Job
metadata:
  name: sync-mistral-24b-model
  namespace: private-ai-demo
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
  labels:
    app.kubernetes.io/part-of: vllm-serving
    app.kubernetes.io/component: sync-model
spec:
  backoffLimit: 2
  template:
    metadata:
      labels:
        app.kubernetes.io/part-of: vllm-serving
        app.kubernetes.io/component: sync-model
    spec:
      serviceAccountName: ai-workload-sa
      restartPolicy: Never
      volumes:
      - name: model-pvc
        persistentVolumeClaim:
          claimName: mistral-24b-pvc
      - name: minio-credentials
        secret:
          secretName: minio-credentials
      containers:
      - name: mc
        image: quay.io/minio/mc:RELEASE.2024-10-08T09-37-26Z
        env:
        - name: MINIO_ENDPOINT
          value: "http://minio.model-storage.svc:9000"
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: accesskey
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secretkey
        volumeMounts:
        - name: model-pvc
          mountPath: /mnt/models
        - name: minio-credentials
          mountPath: /var/run/secrets/minio
          readOnly: true
        command:
        - /bin/sh
        - -lc
        args:
        - |
          set -euo pipefail
          echo "Configuring MinIO alias..."
          mc alias set minio "$MINIO_ENDPOINT" "$MINIO_ACCESS_KEY" "$MINIO_SECRET_KEY"
          SRC="minio/llm-models/Mistral-Small-24B-Instruct/full-fp16/"
          echo "Mirroring from ${SRC} to PVC at /mnt/models ..."
          mc mirror --overwrite --remove "$SRC" /mnt/models/
          echo "Sync complete."

