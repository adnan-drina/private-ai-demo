---
apiVersion: serving.kserve.io/v1beta1
kind: InferenceService
metadata:
  name: mistral-24b-quantized
  namespace: private-ai-demo
  labels:
    app.kubernetes.io/part-of: vllm-serving
    app.kubernetes.io/component: inference
    app.kubernetes.io/name: mistral-24b-quantized
    app.openshift.io/runtime: python
    opendatahub.io/dashboard: "true"
    modelregistry.opendatahub.io/name: private-ai-model-registry
    modelregistry.opendatahub.io/registered-model-name: "Mistral-Small-24B-Instruct"
    modelregistry.opendatahub.io/model-version: "quant-w4a16"
    modelregistry.opendatahub.io/inference-service-id: "11"
  annotations:
    argocd.argoproj.io/sync-wave: "5"
    app.openshift.io/connects-to: '[{"apiVersion":"apps/v1","kind":"Deployment","name":"llama-stack"}]'
    openshift.io/display-name: "Mistral-24B-quantized"
    serving.kserve.io/deploymentMode: "Serverless"
    description: "Mistral Small 24B Instruct W4A16 quantized - 1 GPU (weights in S3)"
    serving.knative.openshift.io/enablePassthrough: "true"
    autoscaling.knative.dev/min-scale: "1"
    autoscaling.knative.dev/target: "6"
    sidecar.istio.io/inject: "true"
    sidecar.istio.io/rewriteAppHTTPProbers: "true"
    security.opendatahub.io/enable-auth: "true"
    # S3 configuration per KServe: host:port + s3-usehttps controls scheme
    serving.kserve.io/s3-endpoint: "minio.model-storage.svc:9000"
    serving.kserve.io/s3-usehttps: "0"
    serving.kserve.io/s3-verifyssl: "0"
    serving.kserve.io/s3-region: "us-east-1"
    serving.kserve.io/s3-secret-name: "s3-credentials-kserve"
spec:
  predictor:
    containerConcurrency: 16  # Phase 1 optimization: match max_num_seqs (was 6)
    serviceAccountName: ai-workload-sa
    automountServiceAccountToken: false
    minReplicas: 1
    maxReplicas: 1
    model:
      modelFormat:
        name: vLLM
      name: ""
      runtime: vllm-cuda-runtime
      # Path B: weights in MinIO (S3-compatible) populated by pipeline
      storageUri: s3://llm-models/Mistral-Small-24B-Instruct/quant-w4a16/
      resources:
        requests:
          cpu: "6"
          memory: 16Gi
          nvidia.com/gpu: "1"
        limits:
          cpu: "10"
          memory: 20Gi
          nvidia.com/gpu: "1"
      # Model-specific vLLM args for Mistral Small 24B quantized (W4A16)
      # Quantization: compressed-tensors (auto-detected by vLLM)
      args:
        - --gpu-memory-utilization=0.90     # Add headroom to reduce 500s
        - --max-model-len=32768             # Mistral Small supports 32K context
        - --max-num-seqs=16                  # Limit concurrent sequences per GPU
        - --enable-chunked-prefill          # Performance optimization
        - --enable-prefix-caching           # Cache optimization for repeated prompts
        - --trust-remote-code               # Allow custom model code
        - --dtype=auto                      # Auto-detect dtype from model config
    # Node placement for g6.4xlarge (1 GPU node) - matches nvidia-l4-1gpu hardware profile
    nodeSelector:
      node.kubernetes.io/instance-type: g6.4xlarge
    tolerations:
      - key: nvidia.com/gpu
        operator: Exists
        effect: NoSchedule
