apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: modelcar-build-deploy
  namespace: private-ai-demo
  labels:
    app.kubernetes.io/name: modelcar-pipeline
    app.kubernetes.io/component: pipeline
    app.kubernetes.io/part-of: private-ai-demo
  annotations:
    argocd.argoproj.io/sync-wave: "4"
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/tags: "mlops,modelcar,vllm"
    tekton.dev/displayName: "ModelCar Build and Deploy Pipeline"
spec:
  description: >-
    ModelCar build and registration pipeline that:
    1. Downloads a model from HuggingFace
    2. Packages it as a ModelCar container image
    3. Pushes to OpenShift internal registry (ImageStream)
    4. (Optional) Mirrors to Quay.io for external access
    5. Registers in Model Registry
    
    Deployment is handled separately for more flexibility.

  params:
    # Model source parameters
    - name: hf_repo
      type: string
      description: HuggingFace repository ID
    
    - name: hf_revision
      type: string
      description: HuggingFace revision to download
      default: "main"
    
    # Image and registry parameters
    - name: image_stream_name
      type: string
      description: Name of the ImageStream in OpenShift
    
    - name: image_tag
      type: string
      description: Tag for the built image
      default: "latest"
    
    - name: quay_org
      type: string
      description: Quay.io organization name
    
    - name: quay_repo
      type: string
      description: Quay.io repository name
    
    - name: quay_tag
      type: string
      description: Tag for Quay image
      default: "latest"
    
    # Model Registry parameters
    - name: model_name
      type: string
      description: Registered model name in Model Registry
    
    - name: version_name
      type: string
      description: Model version identifier
    
    - name: version_description
      type: string
      description: Description for this model version
      default: ""
    
    - name: base_model
      type: string
      description: Base model HuggingFace ID (for metadata)
      default: ""
    
    - name: quantization
      type: string
      description: Quantization type (e.g., w4a16, fp16, none)
      default: "none"
    
    - name: gpu_requirement
      type: string
      description: Number of GPUs required for deployment
      default: "1"
    
    # Internal parameters (computed)
    - name: internal_registry
      type: string
      description: OpenShift internal registry hostname
      default: "image-registry.openshift-image-registry.svc:5000"
    
    - name: namespace
      type: string
      description: Target namespace
      default: "private-ai-demo"

  workspaces:
    - name: shared-workspace
      description: Shared workspace for build context and artifacts

  # Note: Timeout configuration is set at PipelineRun level, not Pipeline level
  # Default PipelineRun timeout: 2h (set when creating PipelineRun)

  tasks:
    # Task 1: Prepare the ModelCar build context
    - name: prepare-context
      taskRef:
        name: prepare-modelcar-context
        kind: Task
      params:
        - name: hf_repo
          value: $(params.hf_repo)
        - name: hf_revision
          value: $(params.hf_revision)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    # Task 2: Build the ModelCar image and push to internal registry (Red Hat Buildah)
    - name: build-and-push
      runAfter: ["prepare-context"]
      timeout: "2h"  # Extended timeout for large model downloads and builds
      taskRef:
        name: buildah-build-modelcar
        kind: Task
      params:
        - name: IMAGE
          value: $(params.internal_registry)/$(params.namespace)/$(params.image_stream_name):$(params.image_tag)
        - name: CONTEXT
          value: $(workspaces.source.path)
        - name: DOCKERFILE
          value: $(workspaces.source.path)/Containerfile
        - name: FORMAT
          value: "oci"
        - name: TLSVERIFY
          value: "false"
        - name: BUILD_EXTRA_ARGS
          value: "--build-arg=HF_REPO=$(params.hf_repo) --build-arg=HF_REVISION=$(params.hf_revision)"
      workspaces:
        - name: source
          workspace: shared-workspace
    
    # Task 3: Mirror to Quay.io (optional - runs in parallel)
    - name: mirror-to-quay
      runAfter: ["build-and-push"]
      taskRef:
        name: mirror-to-quay
        kind: Task
      params:
        - name: src_image
          value: $(params.internal_registry)/$(params.namespace)/$(params.image_stream_name):$(params.image_tag)
        - name: dest_image
          value: quay.io/$(params.quay_org)/$(params.quay_repo):$(params.quay_tag)
    
    # Task 4: Register the model in Model Registry
    # Uses OpenShift internal registry (not Quay)
    # Pipeline ends here - deployment is handled separately
    - name: register-model
      runAfter: ["build-and-push"]
      taskRef:
        name: register-model
        kind: Task
      params:
        - name: model_name
          value: $(params.model_name)
        - name: version_name
          value: $(params.version_name)
        - name: image_uri
          value: oci://$(params.internal_registry)/$(params.namespace)/$(params.image_stream_name):$(params.image_tag)
        - name: model_format_name
          value: "ModelCar"
        - name: model_format_version
          value: "1"
        - name: description
          value: $(params.version_description)
        - name: base_model
          value: $(params.base_model)
        - name: quantization
          value: $(params.quantization)
        - name: gpu_requirement
          value: $(params.gpu_requirement)

  finally:
    - name: cleanup-workspace
      taskSpec:
        steps:
          - name: cleanup
            image: registry.access.redhat.com/ubi9/ubi-minimal:latest
            script: |
              #!/bin/bash
              echo "ðŸ§¹ Pipeline execution completed"
              echo "âœ… ModelCar built and registered in Model Registry"
              echo "Check registered model: oc get registeredmodels -n private-ai-model-registry"
      workspaces:
        - name: source
          workspace: shared-workspace

