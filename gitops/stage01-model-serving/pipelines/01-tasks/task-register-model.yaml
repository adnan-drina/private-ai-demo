apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: register-model
  namespace: private-ai-demo
  labels:
    app.kubernetes.io/name: register-model
    app.kubernetes.io/component: pipeline-task
    app.kubernetes.io/part-of: private-ai-demo
  annotations:
    argocd.argoproj.io/sync-wave: "3"
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/tags: "model-registry,mlops"
    tekton.dev/displayName: "Register Model in Model Registry"
spec:
  description: >-
    This task registers a model in the OpenShift AI Model Registry using the
    v1alpha3 API. It creates or updates a RegisteredModel and creates a new
    ModelVersion pointing to the ModelCar OCI image.

  params:
    - name: model_name
      type: string
      description: Name of the registered model (e.g., "Mistral-24B-Instruct")
    
    - name: version_name
      type: string
      description: Version identifier (e.g., "quantized-2501", "full-2501")
    
    - name: image_uri
      type: string
      description: OCI image URI (e.g., "oci://quay.io/org/model:tag")
    
    - name: model_format_name
      type: string
      description: Model format name
      default: "ModelCar"
    
    - name: model_format_version
      type: string
      description: Model format version
      default: "1"
    
    - name: description
      type: string
      description: Model version description
      default: ""

  steps:
    - name: register-via-api
      image: registry.access.redhat.com/ubi9/python-311:latest
      env:
        - name: MODEL_REGISTRY_URL
          valueFrom:
            secretKeyRef:
              name: model-registry-config
              key: MR_BASE_URL
              optional: false
      script: |
        #!/usr/bin/env python3
        import os
        import sys
        import json
        import requests
        from urllib.parse import urljoin
        
        print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
        print("ğŸ“ Registering Model in Model Registry")
        print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
        
        # Get parameters
        model_name = "$(params.model_name)"
        version_name = "$(params.version_name)"
        image_uri = "$(params.image_uri)"
        format_name = "$(params.model_format_name)"
        format_version = "$(params.model_format_version)"
        description = "$(params.description)" or f"ModelCar image {image_uri}"
        
        print(f"Model Name:    {model_name}")
        print(f"Version:       {version_name}")
        print(f"Image URI:     {image_uri}")
        print(f"Format:        {format_name} v{format_version}")
        print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
        
        # Get Model Registry URL
        mr_base_url = os.environ.get("MODEL_REGISTRY_URL")
        if not mr_base_url:
            print("âŒ ERROR: MODEL_REGISTRY_URL not set", file=sys.stderr)
            sys.exit(1)
        
        print(f"Registry URL:  {mr_base_url}")
        
        # Setup session with auth
        session = requests.Session()
        session.headers["Content-Type"] = "application/json"
        
        # Try to get service account token
        token_path = "/var/run/secrets/kubernetes.io/serviceaccount/token"
        if os.path.exists(token_path):
            with open(token_path, 'r') as f:
                token = f.read().strip()
                session.headers["Authorization"] = f"Bearer {token}"
                print("âœ… Using ServiceAccount token for authentication")
        else:
            print("âš ï¸  No ServiceAccount token found, proceeding without auth")
        
        try:
            # Step 1: Find or create RegisteredModel
            print("\nğŸ” Looking for existing RegisteredModel...")
            response = session.get(
                urljoin(mr_base_url, "registered_models"),
                params={"filter": f"name=='{model_name}'"}
            )
            response.raise_for_status()
            
            items = response.json().get("items", [])
            if items:
                rm_id = items[0]["id"]
                print(f"âœ… Found existing RegisteredModel: {rm_id}")
            else:
                print(f"ğŸ“ Creating new RegisteredModel: {model_name}")
                payload = {
                    "name": model_name,
                    "description": f"Model serving for {model_name}",
                    "customProperties": {
                        "source": {"string_value": "HuggingFace"},
                        "deployment_type": {"string_value": "vLLM"},
                        "pipeline": {"string_value": "ModelCar"}
                    }
                }
                response = session.post(
                    urljoin(mr_base_url, "registered_models"),
                    data=json.dumps(payload)
                )
                response.raise_for_status()
                rm_id = response.json()["id"]
                print(f"âœ… Created RegisteredModel: {rm_id}")
            
            # Step 2: Create ModelVersion
            print(f"\nğŸ“ Creating ModelVersion: {version_name}")
            payload = {
                "name": version_name,
                "description": description,
                "modelSource": {
                    "modelFormat": {
                        "name": format_name,
                        "version": format_version
                    },
                    "uri": image_uri
                },
                "customProperties": {
                    "container_image": {"string_value": image_uri},
                    "format": {"string_value": "ModelCar"},
                    "registry": {"string_value": "Quay.io"}
                }
            }
            
            response = session.post(
                urljoin(mr_base_url, f"registered_models/{rm_id}/versions"),
                data=json.dumps(payload)
            )
            
            if response.status_code not in (200, 201):
                print(f"âŒ ERROR: Registration failed", file=sys.stderr)
                print(f"Status: {response.status_code}", file=sys.stderr)
                print(f"Response: {response.text}", file=sys.stderr)
                sys.exit(1)
            
            version_id = response.json()["id"]
            print(f"âœ… Created ModelVersion: {version_id}")
            
            print("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
            print("âœ… Model registered successfully!")
            print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
            
        except requests.exceptions.RequestException as e:
            print(f"\nâŒ ERROR: API request failed: {e}", file=sys.stderr)
            if hasattr(e, 'response') and e.response is not None:
                print(f"Status: {e.response.status_code}", file=sys.stderr)
                print(f"Response: {e.response.text}", file=sys.stderr)
            sys.exit(1)
        except Exception as e:
            print(f"\nâŒ ERROR: {e}", file=sys.stderr)
            sys.exit(1)

