apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: buildah-build-modelcar
  namespace: private-ai-demo
  labels:
    app.kubernetes.io/name: buildah-build
    app.kubernetes.io/component: pipeline-task
    app.kubernetes.io/part-of: private-ai-demo
  annotations:
    argocd.argoproj.io/sync-wave: "3"
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/tags: "image-build,buildah"
    tekton.dev/displayName: "Buildah Build for ModelCar"
spec:
  description: >-
    This task builds a ModelCar container image using Red Hat Buildah.
    Buildah is rootless and works seamlessly with OpenShift's security model.

  params:
    - name: IMAGE
      type: string
      description: Reference of the image to build (e.g., image-registry.openshift-image-registry.svc:5000/namespace/name:tag)
    
    - name: DOCKERFILE
      type: string
      description: Path to the Containerfile/Dockerfile
      default: ./Containerfile
    
    - name: CONTEXT
      type: string
      description: Path to the build context
      default: .
    
    - name: FORMAT
      type: string
      description: Format of the built image (oci or docker)
      default: "oci"
    
    - name: TLSVERIFY
      type: string
      description: Verify TLS on the registry endpoint
      default: "false"
    
    - name: BUILD_EXTRA_ARGS
      type: string
      description: Extra arguments passed to buildah bud
      default: ""

  workspaces:
    - name: source
      description: Workspace containing the build context
    - name: registry-auth
      description: Docker registry authentication secret
      optional: true

  results:
    - name: IMAGE_DIGEST
      description: Digest of the image just built
    
    - name: IMAGE_URL
      description: URL of the image just built

  steps:
    - name: build-and-push
      image: registry.redhat.io/rhel9/buildah:latest
      workingDir: $(workspaces.source.path)
      # Resource requirements for large model builds (20GB+ models)
      computeResources:
        requests:
          memory: "8Gi"
          cpu: "2"
        limits:
          memory: "16Gi"  # Adequate for 20GB model download + build
          cpu: "4"
      # Use workspace subdirectory for ALL Buildah operations (avoids ephemeral-storage exhaustion)
      env:
        - name: BUILDAH_STORAGE_ROOT
          value: $(workspaces.source.path)/.buildah-storage
        - name: STORAGE_DRIVER
          value: vfs
        - name: TMPDIR
          value: $(workspaces.source.path)/.tmp
        - name: HOME
          value: $(workspaces.source.path)/.home
        - name: HF_TOKEN
          valueFrom:
            secretKeyRef:
              name: hf-token
              key: HF_TOKEN
              optional: true
      script: |
        #!/bin/bash
        set -e
        
        # Create all directories in workspace PVC to avoid ephemeral storage
        echo "ğŸ“ Setting up PVC-backed directories..."
        mkdir -p ${BUILDAH_STORAGE_ROOT}
        mkdir -p ${TMPDIR}
        mkdir -p ${HOME}
        
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ”¨ Building ModelCar Image with Buildah"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Context:     $(params.CONTEXT)"
        echo "Dockerfile:  $(params.DOCKERFILE)"
        echo "Destination: $(params.IMAGE)"
        echo "Format:      $(params.FORMAT)"
        echo "Storage:     ${BUILDAH_STORAGE_ROOT} (PVC-backed)"
        echo "Temp Dir:    ${TMPDIR} (PVC-backed)"
        echo "Home Dir:    ${HOME} (PVC-backed)"
        echo "HF Token:    ${HF_TOKEN:+<set>}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Build the image (using PVC storage)
        # Pass HF_TOKEN as build arg if set
        if [ -n "${HF_TOKEN}" ]; then
          echo "ğŸ” Using HF_TOKEN for model download authentication"
          buildah --root ${BUILDAH_STORAGE_ROOT} --storage-driver=vfs bud \
            --format=$(params.FORMAT) \
            --tls-verify=$(params.TLSVERIFY) \
            --no-cache \
            --build-arg=HF_TOKEN="${HF_TOKEN}" \
            -f $(params.DOCKERFILE) \
            -t $(params.IMAGE) \
            $(params.BUILD_EXTRA_ARGS) \
            $(params.CONTEXT)
        else
          echo "âš ï¸  No HF_TOKEN provided - downloading public models only"
          buildah --root ${BUILDAH_STORAGE_ROOT} --storage-driver=vfs bud \
            --format=$(params.FORMAT) \
            --tls-verify=$(params.TLSVERIFY) \
            --no-cache \
            -f $(params.DOCKERFILE) \
            -t $(params.IMAGE) \
            $(params.BUILD_EXTRA_ARGS) \
            $(params.CONTEXT)
        fi
        
        echo ""
        echo "ğŸ“¤ Pushing image to registry..."
        
        # Authenticate using mounted registry secret
        # This secret contains the dockerconfigjson for internal registry
        if [ -f "/workspace/registry-auth/.dockerconfigjson" ]; then
          echo "ğŸ” Using registry auth secret for authentication"
          export REGISTRY_AUTH_FILE=/workspace/registry-auth/.dockerconfigjson
          
          # Push the image using mounted credentials
          buildah --root ${BUILDAH_STORAGE_ROOT} --storage-driver=vfs push \
            --authfile ${REGISTRY_AUTH_FILE} \
            --tls-verify=$(params.TLSVERIFY) \
            --digestfile /tmp/image-digest \
            $(params.IMAGE) \
            docker://$(params.IMAGE)
        else
          echo "âš ï¸  No registry auth secret found - attempting push without explicit auth"
          # Fallback: Push without explicit credentials (may fail)
          buildah --root ${BUILDAH_STORAGE_ROOT} --storage-driver=vfs push \
            --tls-verify=$(params.TLSVERIFY) \
            --digestfile /tmp/image-digest \
            $(params.IMAGE) \
            docker://$(params.IMAGE)
        fi
        
        # Save results
        cat /tmp/image-digest | tee /tekton/results/IMAGE_DIGEST
        echo -n "$(params.IMAGE)" | tee /tekton/results/IMAGE_URL
        
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ… Build and Push Complete!"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Image: $(params.IMAGE)"
        echo "Digest: $(cat /tmp/image-digest)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      securityContext:
        capabilities:
          add:
            - SETFCAP

