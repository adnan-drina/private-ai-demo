apiVersion: tekton.dev/v1
kind: ClusterTask
metadata:
  name: kaniko-build-modelcar
  labels:
    app.kubernetes.io/name: kaniko-build
    app.kubernetes.io/component: pipeline-task
    app.kubernetes.io/part-of: private-ai-demo
  annotations:
    argocd.argoproj.io/sync-wave: "3"
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/tags: "image-build"
    tekton.dev/displayName: "Kaniko Build for ModelCar"
spec:
  description: >-
    This ClusterTask builds a ModelCar container image using Kaniko.
    It does not require a Docker daemon and is fully OCI-compliant.
    
    The task supports building model container images with HuggingFace
    model downloads baked into the image layers.

  params:
    - name: IMAGE
      type: string
      description: Destination image with registry, namespace, name, and tag (e.g., registry.io/ns/name:tag)
    
    - name: CONTEXT
      type: string
      description: Path to the build context within the workspace
      default: /workspace/source
    
    - name: DOCKERFILE
      type: string
      description: Path to the Dockerfile/Containerfile within the workspace
      default: $(params.CONTEXT)/Containerfile
    
    - name: EXTRA_ARGS
      type: array
      description: Additional arguments to pass to Kaniko executor
      default: []
    
    - name: BUILDER_IMAGE
      type: string
      description: The Kaniko executor image to use
      default: gcr.io/kaniko-project/executor:v1.23.2

  workspaces:
    - name: source
      description: Workspace containing the build context

  results:
    - name: IMAGE_DIGEST
      description: Digest of the image just built
    
    - name: IMAGE_URL
      description: URL of the image just built

  steps:
    - name: build-and-push
      image: $(params.BUILDER_IMAGE)
      env:
        - name: DOCKER_CONFIG
          value: /tekton/home/.docker/
      workingDir: $(workspaces.source.path)
      script: |
        #!/busybox/sh
        set -e
        
        echo "════════════════════════════════════════════════════════════"
        echo "🔨 Building ModelCar Image with Kaniko"
        echo "════════════════════════════════════════════════════════════"
        echo "Context:     $(params.CONTEXT)"
        echo "Dockerfile:  $(params.DOCKERFILE)"
        echo "Destination: $(params.IMAGE)"
        echo "════════════════════════════════════════════════════════════"
        
        # Build the argument list
        ARGS="--context=$(params.CONTEXT) \
              --dockerfile=$(params.DOCKERFILE) \
              --destination=$(params.IMAGE) \
              --digest-file=/tekton/results/IMAGE_DIGEST \
              --insecure-registry=image-registry.openshift-image-registry.svc:5000 \
              --skip-tls-verify-registry=image-registry.openshift-image-registry.svc \
              --cache=true \
              --cache-ttl=24h \
              --compressed-caching=false"
        
        # Add extra args if provided
        for arg in "$@"; do
          ARGS="$ARGS $arg"
        done
        
        # Execute kaniko
        /kaniko/executor $ARGS
        
        # Write image URL result
        echo -n "$(params.IMAGE)" > /tekton/results/IMAGE_URL
        
        echo "════════════════════════════════════════════════════════════"
        echo "✅ Build Complete!"
        echo "════════════════════════════════════════════════════════════"
      args:
        - $(params.EXTRA_ARGS[*])
      securityContext:
        runAsUser: 0
        capabilities:
          add:
            - CHOWN
            - DAC_OVERRIDE
            - FOWNER
            - SETGID
            - SETUID
            - SETFCAP

