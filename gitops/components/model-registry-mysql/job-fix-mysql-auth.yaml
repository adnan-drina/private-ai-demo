---
apiVersion: batch/v1
kind: Job
metadata:
  name: fix-mysql-auth
  namespace: rhoai-model-registries
  labels:
    app.kubernetes.io/name: model-registry-mysql
    app.kubernetes.io/component: auth-fix
    app.kubernetes.io/part-of: model-registry
  annotations:
    description: "Fixes MySQL authentication plugin for MLMD compatibility"
spec:
  template:
    metadata:
      annotations:
        sidecar.istio.io/inject: "false"
    spec:
      restartPolicy: OnFailure
      containers:
        - name: fix-auth
          image: docker.io/mysql:8.0
          command: ["/bin/bash", "-c"]
          args:
            - |
              echo "Waiting for MySQL to be ready..."
              until mysql -h private-ai-registry-db.rhoai-model-registries.svc.cluster.local \
                         -uroot -p${MYSQL_ROOT_PASSWORD} -e "SELECT 1" &>/dev/null; do
                echo "MySQL not ready, waiting 5 seconds..."
                sleep 5
              done
              
              echo "MySQL is ready. Fixing authentication plugin for MLMD compatibility..."
              mysql -h private-ai-registry-db.rhoai-model-registries.svc.cluster.local \
                    -uroot -p${MYSQL_ROOT_PASSWORD} <<SQL
              ALTER USER 'root'@'%' IDENTIFIED WITH mysql_native_password BY '${MYSQL_ROOT_PASSWORD}';
              ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '${MYSQL_ROOT_PASSWORD}';
              ALTER USER '${MYSQL_USER}'@'%' IDENTIFIED WITH mysql_native_password BY '${MYSQL_PASSWORD}';
              FLUSH PRIVILEGES;
              SQL
              
              if [ $? -eq 0 ]; then
                echo "✅ Authentication plugin fixed successfully!"
                echo "Verifying users:"
                mysql -h private-ai-registry-db.rhoai-model-registries.svc.cluster.local \
                      -uroot -p${MYSQL_ROOT_PASSWORD} \
                      -e "SELECT user, host, plugin FROM mysql.user WHERE user IN ('root', '${MYSQL_USER}');"
              else
                echo "❌ Failed to fix authentication plugin"
                exit 1
              fi
          envFrom:
            - secretRef:
                name: private-ai-registry-db-secret

