---
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  name: 99-worker-gpu-base
  labels:
    machineconfiguration.openshift.io/role: worker-gpu
spec:
  config:
    ignition:
      version: 3.2.0
    systemd:
      units:
        # Ensure NVIDIA drivers are loaded at boot
        - name: nvidia-driver-load.service
          enabled: true
          contents: |
            [Unit]
            Description=Load NVIDIA kernel modules
            After=network.target
            Before=kubelet.service
            
            [Service]
            Type=oneshot
            ExecStart=/usr/bin/bash -c 'lsmod | grep -q nvidia || modprobe nvidia'
            RemainAfterExit=yes
            
            [Install]
            WantedBy=multi-user.target
        
        # Configure system for optimal GPU performance
        - name: gpu-tuning.service
          enabled: true
          contents: |
            [Unit]
            Description=GPU Performance Tuning
            After=network.target
            
            [Service]
            Type=oneshot
            ExecStart=/usr/bin/bash -c 'echo "GPU tuning applied"'
            RemainAfterExit=yes
            
            [Install]
            WantedBy=multi-user.target
    
    storage:
      files:
        # GPU monitoring and logging configuration
        - path: /etc/nvidia-container-runtime/config.toml
          mode: 0644
          overwrite: true
          contents:
            inline: |
              disable-require = false
              
              [nvidia-container-cli]
              debug = "/var/log/nvidia-container-toolkit.log"
              
              [nvidia-container-runtime]
              debug = "/var/log/nvidia-container-runtime.log"
        
        # Kernel parameters for GPU workloads
        - path: /etc/sysctl.d/99-gpu-tuning.conf
          mode: 0644
          overwrite: true
          contents:
            inline: |
              # GPU Performance Tuning
              # Increase max map count for GPU memory management
              vm.max_map_count = 262144
              
              # Network optimizations for distributed GPU workloads
              net.core.rmem_max = 134217728
              net.core.wmem_max = 134217728
              net.ipv4.tcp_rmem = 4096 87380 67108864
              net.ipv4.tcp_wmem = 4096 65536 67108864
              
              # Disable swap for GPU workloads (optional but recommended)
              vm.swappiness = 0
        
        # GPU node labeling script
        - path: /usr/local/bin/label-gpu-node.sh
          mode: 0755
          overwrite: true
          contents:
            inline: |
              #!/bin/bash
              # This script runs after node registration to apply GPU-specific labels
              
              # Get NVIDIA GPU info
              GPU_COUNT=$(nvidia-smi --query-gpu=count --format=csv,noheader 2>/dev/null || echo "0")
              GPU_MODEL=$(nvidia-smi --query-gpu=name --format=csv,noheader | head -1 2>/dev/null || echo "unknown")
              GPU_MEMORY=$(nvidia-smi --query-gpu=memory.total --format=csv,noheader,nounits | head -1 2>/dev/null || echo "0")
              
              echo "GPU Count: $GPU_COUNT"
              echo "GPU Model: $GPU_MODEL"
              echo "GPU Memory: ${GPU_MEMORY}Mi"

