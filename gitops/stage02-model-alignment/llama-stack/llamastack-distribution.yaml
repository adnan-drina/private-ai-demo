---
# LlamaStackDistribution for RHOAI 2.25
# Reference: https://docs.redhat.com/en/documentation/red_hat_openshift_ai_self-managed/2.25/html-single/working_with_llama_stack/index
apiVersion: llamastack.io/v1alpha1
kind: LlamaStackDistribution
metadata:
  name: llama-stack
  namespace: private-ai-demo
  labels:
    app: llama-stack
    app.kubernetes.io/name: llama-stack
    app.kubernetes.io/component: rag-stack
    app.kubernetes.io/part-of: private-ai-demo
    app.openshift.io/runtime: python
  annotations:
    app.openshift.io/connects-to: '[{"apiVersion":"apps/v1","kind":"Deployment","name":"milvus-standalone"},{"apiVersion":"apps/v1","kind":"Deployment","name":"docling"}]'
    openshift.io/display-name: "Llama Stack (RHOAI 2.25)"
    description: "Llama Stack RAG runtime with vLLM inference, Milvus vector storage, and Docling document processing"
spec:
  replicas: 1
  
  server:
    # Use the full Llama Stack distribution image for RHOAI 2.25
    distribution:
      image: "registry.redhat.io/rhoai/odh-llama-stack-rhel9:2.25"
    
    containerSpec:
      name: llamastack
      port: 8321
      
      env:
        # Config and writable homes
        - name: LLAMA_STACK_CONFIG
          value: "/opt/app-root/run.yaml"
        - name: LLAMA_STACK_HOME
          value: "/data/.llama"

        # vLLM endpoint (external HTTPS Route)
        - name: VLLM_URL
          value: "https://mistral-24b-quantized-private-ai-demo.apps.cluster-gmgrr.gmgrr.sandbox5294.opentlc.com/v1"
        - name: VLLM_API_TOKEN
          value: "fake"
        - name: VLLM_TLS_VERIFY
          value: "false"

        # Milvus (gRPC)
        - name: MILVUS_URI
          value: "tcp://milvus-standalone.private-ai-demo.svc.cluster.local:19530"
      
      resources:
        requests:
          memory: "2Gi"
          cpu: "1"
          ephemeral-storage: "5Gi"
        limits:
          memory: "4Gi"
          cpu: "2"
          ephemeral-storage: "10Gi"
    
    # Pod-level configuration
    podOverrides:
      serviceAccountName: rag-workload-sa
      imagePullSecrets:
        - name: redhat-pull-secret
      
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: llamastack-data
        - name: config
          configMap:
            name: llamastack-config
      
      volumeMounts:
        - name: data
          mountPath: /data
        - name: config
          mountPath: /opt/app-root/run.yaml
          subPath: run.yaml
          readOnly: true
