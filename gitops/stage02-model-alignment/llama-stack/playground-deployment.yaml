---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: llama-stack-playground
  namespace: private-ai-demo
  labels:
    app: llama-stack-playground
    app.kubernetes.io/name: llama-stack-playground
    app.kubernetes.io/component: rag-ui
    app.kubernetes.io/part-of: private-ai-demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: llama-stack-playground
  template:
    metadata:
      labels:
        app: llama-stack-playground
        app.kubernetes.io/name: llama-stack-playground
        app.kubernetes.io/component: rag-ui
        app.kubernetes.io/part-of: private-ai-demo
        app.openshift.io/runtime: python
      annotations:
        # Topology: Connects to LlamaStack API
        app.openshift.io/connects-to: '[{"apiVersion":"v1","kind":"Service","name":"llama-stack-service"}]'
        app.openshift.io/vcs-uri: https://github.com/adnan-drina/private-ai-demo
        app.openshift.io/vcs-ref: feature/stage2-implementation
        # No Istio sidecar needed for UI
        sidecar.istio.io/inject: "false"
    spec:
      serviceAccountName: llama-stack
      containers:
        - name: playground
          # Pinned to specific digest for reproducibility (verified 2025-11-07)
          image: quay.io/rh-aiservices-bu/llama-stack-playground@sha256:56be9a862f2b9152ec698f763d762fe426eb8b1c211980a5dd5d7c501b5c25d1
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 8501
              protocol: TCP
          env:
            # LlamaStack API endpoints (internal and external)
            - name: LLAMA_STACK_BASE_URL
              value: http://llama-stack-service.private-ai-demo.svc:8321
            - name: LLAMA_STACK_URL
              value: http://llama-stack-service.private-ai-demo.svc:8321
            - name: LLAMA_STACK_ENDPOINT
              value: http://llama-stack-service.private-ai-demo.svc:8321
            # Public-facing endpoint for browser
            - name: NEXT_PUBLIC_LLAMA_STACK_URL
              value: https://llamastack-private-ai-demo.apps.cluster-gmgrr.gmgrr.sandbox5294.opentlc.com
            # NOTE: No RAG_DEFAULT_VECTOR_DB_ID - Playground UI will explicitly select from /v1/vector-dbs
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi
          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 10
            periodSeconds: 5
          livenessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: llama-stack-playground
  namespace: private-ai-demo
  labels:
    app: llama-stack-playground
    app.kubernetes.io/name: llama-stack-playground
    app.kubernetes.io/component: rag-ui
    app.kubernetes.io/part-of: private-ai-demo
spec:
  selector:
    app: llama-stack-playground
  ports:
    - name: http
      port: 8501
      targetPort: http
      protocol: TCP
  type: ClusterIP
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: llama-stack-playground
  namespace: private-ai-demo
  labels:
    app: llama-stack-playground
    app.kubernetes.io/name: llama-stack-playground
    app.kubernetes.io/component: rag-ui
    app.kubernetes.io/part-of: private-ai-demo
spec:
  to:
    kind: Service
    name: llama-stack-playground
  port:
    targetPort: http
  tls:
    termination: edge
    insecureEdgeTerminationPolicy: Redirect

