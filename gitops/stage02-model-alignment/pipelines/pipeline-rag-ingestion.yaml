---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: rag-document-ingestion
  namespace: private-ai-demo
  labels:
    app: docling-rag-pipeline
    component: data-processing
  annotations:
    description: "Automated document processing and RAG ingestion pipeline"
spec:
  description: |
    This pipeline automates the complete document processing workflow:
    1. Download or reference source PDFs
    2. Process with Docling (convert to Markdown + JSON with metadata)
    3. Extract and normalize citations (article IDs, page numbers, etc.)
    4. Chunk documents (heading-aware, preserve tables/annexes)
    5. Embed and ingest into Milvus via Llama Stack API
    6. Verify ingestion and index health
  
  params:
    - name: scenario
      type: string
      description: "Scenario name (e.g., eu-ai-act, red-hat-docs)"
      default: "eu-ai-act"
    
    - name: documents
      type: array
      description: "List of document filenames to process"
      default:
        - "eu-ai-act-official-journal.pdf"
        - "eprs-timeline-2025.pdf"
        - "commission-qanda-2024.pdf"
    
    - name: docling-service-url
      type: string
      description: "Docling service endpoint"
      default: "http://shared-docling-service.ai-infrastructure.svc:5001"
    
    - name: llamastack-service-url
      type: string
      description: "Llama Stack service endpoint for ingestion"
      default: "http://llamastack.private-ai-demo.svc:8321"
    
    - name: milvus-collection
      type: string
      description: "Milvus collection name"
      default: "rag_documents"
    
    - name: chunk-size
      type: string
      description: "Chunk size in tokens"
      default: "512"
    
    - name: chunk-overlap
      type: string
      description: "Chunk overlap in tokens"
      default: "50"
  
  workspaces:
    - name: documents-pvc
      description: "Shared workspace for documents and processed outputs"
    
    - name: processing-temp
      description: "Temporary workspace for intermediate processing"
  
  tasks:
    # ========================================================================
    # TASK 1: Prepare Documents
    # ========================================================================
    - name: prepare-documents
      taskRef:
        name: prepare-documents
      params:
        - name: scenario
          value: $(params.scenario)
        - name: documents
          value: $(params.documents[*])
      workspaces:
        - name: documents
          workspace: documents-pvc
    
    # ========================================================================
    # TASK 2: Process with Docling (Parallel)
    # ========================================================================
    - name: process-with-docling
      runAfter:
        - prepare-documents
      taskRef:
        name: docling-process
      params:
        - name: scenario
          value: $(params.scenario)
        - name: document
          value: $(params.documents[*])
        - name: docling-url
          value: $(params.docling-service-url)
      workspaces:
        - name: documents
          workspace: documents-pvc
        - name: temp
          workspace: processing-temp
    
    # ========================================================================
    # TASK 3: Extract Metadata & Citations
    # ========================================================================
    - name: extract-metadata
      runAfter:
        - process-with-docling
      taskRef:
        name: extract-metadata
      params:
        - name: scenario
          value: $(params.scenario)
      workspaces:
        - name: documents
          workspace: documents-pvc
    
    # ========================================================================
    # TASK 4: Chunk Documents
    # ========================================================================
    - name: chunk-documents
      runAfter:
        - extract-metadata
      taskRef:
        name: chunk-documents
      params:
        - name: scenario
          value: $(params.scenario)
        - name: chunk-size
          value: $(params.chunk-size)
        - name: chunk-overlap
          value: $(params.chunk-overlap)
      workspaces:
        - name: documents
          workspace: documents-pvc
    
    # ========================================================================
    # TASK 5: Ingest into Milvus via Llama Stack
    # ========================================================================
    - name: ingest-to-milvus
      runAfter:
        - chunk-documents
      taskRef:
        name: ingest-to-milvus
      params:
        - name: scenario
          value: $(params.scenario)
        - name: llamastack-url
          value: $(params.llamastack-service-url)
        - name: collection
          value: $(params.milvus-collection)
      workspaces:
        - name: documents
          workspace: documents-pvc
    
    # ========================================================================
    # TASK 6: Verify Ingestion
    # ========================================================================
    - name: verify-ingestion
      runAfter:
        - ingest-to-milvus
      taskRef:
        name: verify-ingestion
      params:
        - name: llamastack-url
          value: $(params.llamastack-service-url)
        - name: collection
          value: $(params.milvus-collection)
        - name: expected-chunks
          value: "100"  # Minimum expected chunks
  
  results:
    - name: documents-processed
      description: "Number of documents processed"
      value: $(tasks.process-with-docling.results.count)
    
    - name: chunks-created
      description: "Number of chunks created"
      value: $(tasks.chunk-documents.results.count)
    
    - name: chunks-ingested
      description: "Number of chunks ingested"
      value: $(tasks.ingest-to-milvus.results.count)
    
    - name: ingestion-status
      description: "Overall ingestion status"
      value: $(tasks.verify-ingestion.results.status)


