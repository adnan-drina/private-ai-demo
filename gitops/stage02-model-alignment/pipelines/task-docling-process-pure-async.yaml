apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: docling-process-pure-async
  namespace: private-ai-demo
spec:
  params:
    - name: scenario
      type: string
      default: "eu-ai-act"
    - name: docling-url
      type: string
      default: "http://shared-docling-service.ai-infrastructure.svc:5001"
  workspaces:
    - name: documents
      mountPath: /workspace/documents
  results:
    - name: processed-count
      description: Number of PDFs successfully processed
  steps:
    - name: process-all-pdfs
      image: python:3.11-slim
      env:
        - name: PYTHONUNBUFFERED
          value: "1"
        - name: SCENARIO
          value: "$(params.scenario)"
        - name: DOCLING_URL
          value: "$(params.docling-url)"
      script: |
        #!/usr/bin/env python3
        import os
        import json
        import time
        from pathlib import Path
        
        # Install requests
        print("üì¶ Installing dependencies...")
        os.system("pip install -q requests")
        import requests
        
        print("=" * 60)
        print("  Docling PDF Processing (Pure Async - No Shortcuts!)")
        print("=" * 60)
        print()
        
        scenario = os.environ.get("SCENARIO", "eu-ai-act")
        docling_url = os.environ.get("DOCLING_URL")
        
        input_dir = Path(f"/workspace/documents/scenario2-{scenario}")
        output_dir = Path(f"/workspace/documents/processed/scenario2-{scenario}")
        output_dir.mkdir(parents=True, exist_ok=True)
        
        print(f"Scenario: {scenario}")
        print(f"Docling URL: {docling_url}")
        print(f"Input: {input_dir}")
        print(f"Output: {output_dir}")
        print(f"Strategy: Pure async for ALL files (no 120s timeout!)")
        print()
        
        def process_pdf_async(pdf_path):
            """Process PDF using async endpoint"""
            basename = pdf_path.stem
            
            # Step 1: Submit to async endpoint
            print(f"   üöÄ Submitting to ASYNC endpoint...")
            
            try:
                with open(pdf_path, 'rb') as f:
                    files = {'files': (pdf_path.name, f, 'application/pdf')}
                    response = requests.post(
                        f"{docling_url}/v1/convert/file/async",
                        files=files,
                        timeout=30
                    )
                
                if response.status_code != 200:
                    print(f"   ‚ùå HTTP {response.status_code}: {response.text}")
                    return None
                
                # Extract task_id
                result = response.json()
                task_id = result.get('task_id')
                
                if not task_id:
                    print(f"   ‚ùå No task_id in response: {result}")
                    return None
                
                print(f"   ‚úÖ Task submitted: {task_id}")
                
            except Exception as e:
                print(f"   ‚ùå Submission error: {e}")
                return None
            
            # Step 2: Poll for completion
            print(f"   ‚è≥ Polling for completion (max 15 minutes)...")
            max_attempts = 180  # 15 minutes
            poll_interval = 5
            
            for attempt in range(max_attempts):
                time.sleep(poll_interval)
                
                try:
                    status_resp = requests.get(
                        f"{docling_url}/v1/status/poll/{task_id}",
                        timeout=10
                    )
                    
                    if status_resp.status_code == 200:
                        status_data = status_resp.json()
                        
                        # DEBUG: Print first response to see structure
                        if attempt == 0:
                            print(f"   üêõ DEBUG - Status response structure: {status_data}")
                        
                        status = status_data.get('task_status', 'unknown')
                        
                        if status == 'success':
                            print(f"   ‚úÖ Conversion complete! (took {attempt * poll_interval}s)")
                            
                            # Step 3: Get result
                            print(f"   üì• Fetching result...")
                            result_resp = requests.get(
                                f"{docling_url}/v1/result/{task_id}",
                                timeout=60
                            )
                            
                            if result_resp.status_code == 200:
                                result_data = result_resp.json()
                                
                                # Try multiple fields for markdown content
                                markdown = (
                                    result_data.get('markdown') or
                                    result_data.get('content') or
                                    result_data.get('document', {}).get('md_content') or
                                    result_data.get('document', {}).get('markdown') or
                                    ''
                                )
                                
                                if markdown:
                                    return markdown
                                else:
                                    print(f"   ‚ùå No markdown content in result")
                                    print(f"   Response keys: {list(result_data.keys())}")
                                    return None
                            else:
                                print(f"   ‚ùå Failed to fetch result: HTTP {result_resp.status_code}")
                                return None
                        
                        elif status == 'failed':
                            error = status_data.get('error', 'Unknown error')
                            print(f"   ‚ùå Conversion failed: {error}")
                            return None
                        
                        elif status in ['processing', 'pending', 'queued', 'started']:
                            # Show progress updates every 60 seconds
                            if attempt % 12 == 0 and attempt > 0:
                                elapsed = attempt * poll_interval
                                print(f"   ‚è≥ Still processing... ({elapsed}s elapsed)")
                        
                        else:
                            # Unexpected status
                            print(f"   ‚ö†Ô∏è  Unexpected status '{status}' - continuing to poll...")
                    
                    elif status_resp.status_code == 404:
                        if attempt < 5:
                            print(f"   ‚ö†Ô∏è  Task not found yet, waiting...")
                        else:
                            print(f"   ‚ùå Task not found after {attempt * poll_interval}s")
                            return None
                    
                    else:
                        print(f"   ‚ö†Ô∏è  Status check returned HTTP {status_resp.status_code}")
                
                except requests.exceptions.Timeout:
                    print(f"   ‚ö†Ô∏è  Status check timeout, retrying...")
                except Exception as e:
                    print(f"   ‚ö†Ô∏è  Poll error: {e}, retrying...")
            
            print(f"   ‚ùå Timeout after {max_attempts * poll_interval} seconds")
            return None
        
        # Process all PDFs
        pdf_files = sorted(input_dir.glob("*.pdf"))
        
        if not pdf_files:
            print("‚ùå No PDF files found!")
            exit(1)
        
        print(f"üìÅ Found {len(pdf_files)} PDF files")
        print()
        
        total_processed = 0
        total_failed = 0
        
        for pdf_file in pdf_files:
            print(f"üìÑ Processing: {pdf_file.name}")
            size_mb = pdf_file.stat().st_size / (1024*1024)
            print(f"   Size: {size_mb:.1f} MB")
            
            try:
                markdown = process_pdf_async(pdf_file)
                
                if markdown:
                    md_file = output_dir / f"{pdf_file.stem}.md"
                    with open(md_file, 'w', encoding='utf-8') as f:
                        f.write(markdown)
                    
                    char_count = len(markdown)
                    print(f"   ‚úÖ Saved: {md_file.name} ({char_count:,} chars)")
                    total_processed += 1
                else:
                    print(f"   ‚ùå Failed to extract content")
                    total_failed += 1
            
            except Exception as e:
                print(f"   ‚ùå Error: {e}")
                import traceback
                traceback.print_exc()
                total_failed += 1
            
            print()
        
        print("=" * 60)
        print("üìä PROCESSING SUMMARY")
        print("=" * 60)
        print(f"Total PDFs: {len(pdf_files)}")
        print(f"Processed: {total_processed}")
        print(f"Failed: {total_failed}")
        print("=" * 60)
        
        # Write result
        with open("$(results.processed-count.path)", 'w') as f:
            f.write(str(total_processed))
        
        if total_processed == 0:
            print("‚ùå No PDFs were processed successfully!")
            exit(1)
        
        if total_failed > 0:
            print(f"‚ö†Ô∏è  {total_failed} PDF(s) failed, but {total_processed} succeeded")
        else:
            print("‚úÖ All PDFs processed successfully!")

