---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: rag-document-ingestion-simple
  namespace: private-ai-demo
  labels:
    app: docling-rag-pipeline
    component: data-processing
spec:
  description: |
    Simplified RAG document ingestion pipeline.
    Processes all PDFs found in the scenario directory.
  
  params:
    - name: scenario
      type: string
      description: "Scenario name (e.g., eu-ai-act)"
      default: "eu-ai-act"
  
  workspaces:
    - name: documents-pvc
      description: "Shared workspace for documents and processed outputs"
  
  tasks:
    # TASK 1: Prepare Documents
    - name: prepare-documents
      taskRef:
        name: prepare-documents
      params:
        - name: scenario
          value: $(params.scenario)
        - name: documents
          value: []  # Empty array, will discover PDFs dynamically
      workspaces:
        - name: documents
          workspace: documents-pvc
    
    # TASK 2: Process All PDFs with Docling (PURE ASYNC - No 120s limit!)
    - name: process-all-pdfs
      runAfter:
        - prepare-documents
      taskRef:
        name: docling-process-pure-async
      params:
        - name: scenario
          value: $(params.scenario)
      workspaces:
        - name: documents
          workspace: documents-pvc
    
    # TASK 3: Extract Metadata
    - name: extract-metadata
      runAfter:
        - process-all-pdfs
      taskRef:
        name: extract-metadata
      params:
        - name: scenario
          value: $(params.scenario)
      workspaces:
        - name: documents
          workspace: documents-pvc
    
    # TASK 4: Chunk Documents
    - name: chunk-documents
      runAfter:
        - extract-metadata
      taskRef:
        name: chunk-documents
      params:
        - name: scenario
          value: $(params.scenario)
        - name: chunk-size
          value: "512"
        - name: chunk-overlap
          value: "50"
      workspaces:
        - name: documents
          workspace: documents-pvc
    
    # TASK 5: Ingest to Milvus (PRODUCTION - Real API)
    - name: ingest-to-milvus
      runAfter:
        - chunk-documents
      taskRef:
        name: ingest-to-milvus-production
      params:
        - name: scenario
          value: $(params.scenario)
        # Uses Task default llamastack-url which we standardized to Service 'llamastack'
      workspaces:
        - name: documents
          workspace: documents-pvc
    
    # TASK 6: Verify Output
    - name: verify-output
      runAfter:
        - ingest-to-milvus
      taskSpec:
        params:
          - name: scenario
            type: string
        workspaces:
          - name: documents
        steps:
          - name: verify
            image: registry.access.redhat.com/ubi8/ubi-minimal:latest
            script: |
              #!/bin/bash
              set -e
              
              echo "Verifying pipeline output for scenario: $(params.scenario)"
              
              PROCESSED_DIR="/workspace/documents/processed/scenario2-$(params.scenario)"
              CHUNKED_DIR="/workspace/documents/chunked/scenario2-$(params.scenario)"
              
              echo "üìÅ Processed files:"
              ls -lh "${PROCESSED_DIR}"/ || echo "No files"
              
              echo ""
              echo "üìÅ Chunked files:"
              ls -lh "${CHUNKED_DIR}"/ || echo "No files"
              
              echo ""
              echo "‚úÖ Pipeline complete!"
      params:
        - name: scenario
          value: $(params.scenario)
      workspaces:
        - name: documents
          workspace: documents-pvc

