---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gpu-machineset-generator-script
  namespace: openshift-machine-api
  labels:
    app.kubernetes.io/name: gpu-machineset-generator
    app.kubernetes.io/part-of: stage00-ai-platform
data:
  generate-gpu-machinesets.sh: |
    #!/bin/bash
    set -euo pipefail

    echo "════════════════════════════════════════════════════════════════"
    echo "GPU MachineSet Generator - Dynamic Generation"
    echo "════════════════════════════════════════════════════════════════"
    echo ""

    # Get cluster infrastructure ID
    INFRA_ID=$(oc get infrastructure cluster -o jsonpath='{.status.infrastructureName}')
    echo "Cluster Infrastructure ID: ${INFRA_ID}"

    # Get first available worker MachineSet to use as template
    WORKER_MS=$(oc get machineset -n openshift-machine-api -o name | grep worker | grep -v gpu | head -1 | sed 's|.*/||')
    echo "Template MachineSet: ${WORKER_MS}"

    # Extract availability zone from worker MachineSet
    AZ=$(echo "${WORKER_MS}" | grep -oE 'us-[a-z]+-[0-9][a-z]$')
    echo "Availability Zone: ${AZ}"
    echo ""

    # Function to create GPU MachineSet
    create_gpu_machineset() {
      local INSTANCE_TYPE=$1
      local GPU_COUNT=$2
      local REPLICAS=$3
      # Convert g6.4xlarge to g6-4xlarge for naming
      local INSTANCE_NAME=$(echo "${INSTANCE_TYPE}" | tr '.' '-')

      local GPU_MS_NAME="${INFRA_ID}-gpu-${INSTANCE_NAME}-${AZ}"

      echo "────────────────────────────────────────────────────────────────"
      echo "Creating GPU MachineSet: ${GPU_MS_NAME}"
      echo "  Instance Type: ${INSTANCE_TYPE}"
      echo "  GPU Count: ${GPU_COUNT}"
      echo "  Replicas: ${REPLICAS}"
      echo "────────────────────────────────────────────────────────────────"

      # Check if MachineSet already exists
      if oc get machineset "${GPU_MS_NAME}" -n openshift-machine-api &>/dev/null; then
        echo "✓ MachineSet ${GPU_MS_NAME} already exists, skipping creation"
        echo ""
        return 0
      fi

      # Clone worker MachineSet and modify for GPU
      oc get machineset "${WORKER_MS}" -n openshift-machine-api -o yaml | \
        sed "s/${WORKER_MS}/${GPU_MS_NAME}/g" | \
        sed "s/replicas: .*/replicas: ${REPLICAS}/" | \
        sed "s/instanceType: .*/instanceType: ${INSTANCE_TYPE}/" | \
        sed '/resourceVersion:/d' | \
        sed '/uid:/d' | \
        sed '/generation:/d' | \
        sed '/creationTimestamp:/d' | \
        sed '/kubectl.kubernetes.io\/last-applied-configuration:/d' | \
        yq eval '
          .metadata.labels["node-role.kubernetes.io/gpu"] = "" |
          .metadata.labels["nvidia.com/gpu.present"] = "true" |
          .metadata.annotations["machine.openshift.io/GPU"] = "'"${GPU_COUNT}"'" |
          .spec.selector.matchLabels["machine.openshift.io/cluster-api-machineset"] = "'"${GPU_MS_NAME}"'" |
          .spec.template.metadata.labels["machine.openshift.io/cluster-api-machineset"] = "'"${GPU_MS_NAME}"'" |
          .spec.template.metadata.labels["node-role.kubernetes.io/gpu"] = "" |
          .spec.template.spec.metadata.labels["node-role.kubernetes.io/gpu"] = "" |
          .spec.template.spec.metadata.labels["nvidia.com/gpu.present"] = "true" |
          .spec.template.spec.taints = [
            {
              "key": "nvidia.com/gpu",
              "value": "true",
              "effect": "NoSchedule"
            }
          ]
        ' - | \
        oc apply -f -

      if [ $? -eq 0 ]; then
        echo "✓ Successfully created MachineSet: ${GPU_MS_NAME}"
      else
        echo "✗ Failed to create MachineSet: ${GPU_MS_NAME}"
        return 1
      fi
      echo ""
    }

    # Create GPU MachineSets
    echo "════════════════════════════════════════════════════════════════"
    echo "Creating GPU MachineSets"
    echo "════════════════════════════════════════════════════════════════"
    echo ""

    # g6.4xlarge: 1x NVIDIA L4 GPU (24GB), 16 vCPU, 64 GB RAM
    create_gpu_machineset "g6.4xlarge" "1" "1"

    # g6.12xlarge: 4x NVIDIA L4 GPU (96GB total), 48 vCPU, 192 GB RAM
    create_gpu_machineset "g6.12xlarge" "4" "1"

    echo "════════════════════════════════════════════════════════════════"
    echo "GPU MachineSet Generation Complete"
    echo "════════════════════════════════════════════════════════════════"
    echo ""
    echo "Listing all GPU MachineSets:"
    oc get machineset -n openshift-machine-api | grep gpu || echo "No GPU MachineSets found"
    echo ""
    echo "Note: GPU nodes will take 10-15 minutes to provision"

