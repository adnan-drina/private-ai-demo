apiVersion: batch/v1
kind: Job
metadata:
  name: minio-bootstrap-buckets
  namespace: model-storage
  labels:
    app.kubernetes.io/part-of: stage00-ai-platform
    app.kubernetes.io/component: object-storage
    app.kubernetes.io/instance: minio-bootstrap
  annotations:
    argocd.argoproj.io/sync-wave: "2"
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  # Keep job history for debugging
  ttlSecondsAfterFinished: 3600
  backoffLimit: 3
  
  template:
    metadata:
      labels:
        app.kubernetes.io/name: minio-bootstrap
    spec:
      restartPolicy: OnFailure
      
      # Service account with MinIO access
      serviceAccountName: minio-sa
      
      containers:
      - name: bootstrap
        image: quay.io/minio/mc:RELEASE.2024-10-08T09-37-26Z
        imagePullPolicy: IfNotPresent
        
        command: ["/bin/bash"]
        args:
        - -c
        - |
          #!/bin/bash
          set -euo pipefail
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "MinIO Bucket Bootstrap - Model Storage"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Wait for MinIO to be ready
          echo "â³ Waiting for MinIO to be ready..."
          MINIO_ENDPOINT="http://minio.model-storage.svc:9000"
          MAX_RETRIES=30
          RETRY=0
          
          while [ $RETRY -lt $MAX_RETRIES ]; do
            if mc alias set minio "$MINIO_ENDPOINT" "$MINIO_ACCESS_KEY" "$MINIO_SECRET_KEY" 2>/dev/null; then
              echo "âœ… MinIO is ready!"
              break
            fi
            RETRY=$((RETRY+1))
            echo "  Attempt $RETRY/$MAX_RETRIES - Waiting for MinIO..."
            sleep 10
          done
          
          if [ $RETRY -eq $MAX_RETRIES ]; then
            echo "âŒ MinIO not ready after $MAX_RETRIES attempts"
            exit 1
          fi
          
          # Create buckets
          echo ""
          echo "ðŸ“¦ Creating buckets..."
          
          # Bucket for LLM model weights
          if mc mb minio/llm-models --ignore-existing --insecure; then
            echo "âœ… Created bucket: llm-models"
          else
            echo "â„¹ï¸  Bucket llm-models already exists"
          fi
          
          # Set bucket policies
          echo ""
          echo "ðŸ” Configuring bucket policies..."
          
          # Allow authenticated read/write for llm-models
          cat > /tmp/llm-models-policy.json << 'POLICY_EOF'
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {"AWS": ["*"]},
                "Action": [
                  "s3:GetBucketLocation",
                  "s3:ListBucket"
                ],
                "Resource": ["arn:aws:s3:::llm-models"]
              },
              {
                "Effect": "Allow",
                "Principal": {"AWS": ["*"]},
                "Action": [
                  "s3:GetObject"
                ],
                "Resource": ["arn:aws:s3:::llm-models/*"]
              }
            ]
          }
          POLICY_EOF
          
          mc anonymous set-json /tmp/llm-models-policy.json minio/llm-models
          echo "âœ… Set policy for llm-models (authenticated read)"
          
          # Enable versioning (good practice for model management)
          echo ""
          echo "ðŸ”„ Enabling versioning..."
          mc version enable minio/llm-models
          echo "âœ… Versioning enabled for llm-models"
          
          # List buckets and verify
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Bootstrap Complete - Bucket Summary:"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          mc ls minio/
          
          echo ""
          echo "Bucket details:"
          mc stat minio/llm-models
          
          echo ""
          echo "ðŸŽ‰ MinIO is ready for model storage!"
        
        env:
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: accesskey
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secretkey
        
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "256Mi"

