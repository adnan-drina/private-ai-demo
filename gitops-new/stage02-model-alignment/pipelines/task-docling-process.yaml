---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: docling-process
  namespace: private-ai-demo
  labels:
    app: docling-rag-pipeline
    component: document-processing
spec:
  description: |
    Process PDF documents using Docling service.
    Converts PDFs to Markdown + JSON with metadata extraction.
  
  params:
    - name: scenario
      type: string
      description: "Scenario name"
    
    - name: document
      type: string
      description: "Document filename to process"
    
    - name: docling-url
      type: string
      description: "Docling service URL"
      default: "http://shared-docling-service.ai-infrastructure.svc:5001"
  
  workspaces:
    - name: documents
      description: "Workspace with source PDFs and output"
      mountPath: /workspace/documents
    
    - name: temp
      description: "Temporary workspace"
      mountPath: /workspace/temp
  
  steps:
    - name: process-pdf
      image: quay.io/curl/curl:latest
      script: |
        #!/bin/sh
        set -e
        
        echo "=========================================="
        echo "  Docling PDF Processing"
        echo "=========================================="
        echo ""
        echo "Scenario: $(params.scenario)"
        echo "Document: $(params.document)"
        echo "Docling URL: $(params.docling-url)"
        echo ""
        
        # Input and output paths
        INPUT_DIR="/workspace/documents/scenario2-$(params.scenario)"
        OUTPUT_DIR="/workspace/documents/processed/scenario2-$(params.scenario)"
        PDF_FILE="${INPUT_DIR}/$(params.document)"
        
        # Create output directory
        mkdir -p "${OUTPUT_DIR}"
        
        # Check if PDF exists
        if [ ! -f "${PDF_FILE}" ]; then
          echo "‚ùå Error: PDF file not found: ${PDF_FILE}"
          exit 1
        fi
        
        echo "‚úÖ Found PDF: ${PDF_FILE}"
        echo "üìÑ Size: $(du -h "${PDF_FILE}" | cut -f1)"
        echo ""
        
        # Submit to Docling (async)
        echo "üöÄ Submitting to Docling..."
        RESPONSE=$(curl -s -X POST \
          "$(params.docling-url)/v1/convert/file/async" \
          -F "files=@${PDF_FILE}")
        
        echo "Response: ${RESPONSE}"
        
        # Extract task ID
        TASK_ID=$(echo "${RESPONSE}" | grep -o '"task_id":"[^"]*"' | cut -d'"' -f4)
        
        if [ -z "${TASK_ID}" ]; then
          echo "‚ùå Error: Failed to extract task_id"
          echo "Response was: ${RESPONSE}"
          exit 1
        fi
        
        echo "‚úÖ Task ID: ${TASK_ID}"
        echo ""
        
        # Poll for completion (max 5 minutes)
        echo "‚è≥ Waiting for processing..."
        MAX_ATTEMPTS=60
        ATTEMPT=0
        
        while [ ${ATTEMPT} -lt ${MAX_ATTEMPTS} ]; do
          ATTEMPT=$((ATTEMPT + 1))
          
          STATUS_RESPONSE=$(curl -s "$(params.docling-url)/v1/result/${TASK_ID}")
          STATUS=$(echo "${STATUS_RESPONSE}" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
          
          echo "  Attempt ${ATTEMPT}/${MAX_ATTEMPTS}: Status = ${STATUS}"
          
          if [ "${STATUS}" = "success" ]; then
            echo ""
            echo "‚úÖ Processing complete!"
            
            # Save full response
            BASENAME=$(basename "${PDF_FILE}" .pdf)
            echo "${STATUS_RESPONSE}" > "${OUTPUT_DIR}/${BASENAME}-response.json"
            
            # Extract markdown content
            echo "${STATUS_RESPONSE}" | \
              grep -o '"md_content":"[^"]*"' | \
              cut -d'"' -f4 | \
              sed 's/\\n/\n/g' > "${OUTPUT_DIR}/${BASENAME}.md"
            
            echo "üìÑ Saved:"
            echo "  - ${OUTPUT_DIR}/${BASENAME}-response.json"
            echo "  - ${OUTPUT_DIR}/${BASENAME}.md"
            echo ""
            
            # Output result for next task
            echo "${BASENAME}" > $(results.processed-doc.path)
            exit 0
          elif [ "${STATUS}" = "failed" ]; then
            echo ""
            echo "‚ùå Processing failed!"
            echo "Response: ${STATUS_RESPONSE}"
            exit 1
          fi
          
          sleep 5
        done
        
        echo ""
        echo "‚ùå Timeout waiting for Docling"
        exit 1
  
  results:
    - name: processed-doc
      description: "Basename of processed document"
    
    - name: count
      description: "Number of documents processed (always 1 for this task)"


