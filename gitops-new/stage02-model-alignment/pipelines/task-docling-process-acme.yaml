apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: docling-process-acme
  namespace: private-ai-demo
  labels:
    app: docling-pipeline
    scenario: acme
spec:
  description: Process ACME PDFs from /documents/acme/pdfs/ using Docling
  params:
    - name: docling-url
      type: string
      default: "http://shared-docling-service.ai-infrastructure.svc:5001"
  workspaces:
    - name: documents
      mountPath: /workspace/documents
  results:
    - name: processed-count
      description: Number of PDFs successfully processed
  steps:
    - name: process-acme-pdfs
      image: python:3.11-slim
      env:
        - name: PYTHONUNBUFFERED
          value: "1"
        - name: DOCLING_URL
          value: "$(params.docling-url)"
      script: |
        #!/usr/bin/env python3
        import os
        import json
        import time
        from pathlib import Path
        
        # Install requests
        print("üì¶ Installing dependencies...")
        os.system("pip install -q requests")
        import requests
        
        print("=" * 70)
        print("  ACME Docling PDF Processing (Pure Async)")
        print("=" * 70)
        print()
        
        docling_url = os.environ.get("DOCLING_URL")
        
        input_dir = Path("/workspace/documents/acme/pdfs")
        output_dir = Path("/workspace/documents/acme/parsed")
        output_dir.mkdir(parents=True, exist_ok=True)
        
        print(f"Docling URL: {docling_url}")
        print(f"Input: {input_dir}")
        print(f"Output: {output_dir}")
        print(f"Strategy: Pure async for all ACME PDFs")
        print()
        
        def process_pdf_async(pdf_path):
            """Process PDF using async endpoint"""
            basename = pdf_path.stem
            
            print(f"üìÑ Processing: {pdf_path.name}")
            print(f"   üöÄ Submitting to ASYNC endpoint...")
            
            try:
                with open(pdf_path, 'rb') as f:
                    files = {'files': (pdf_path.name, f, 'application/pdf')}
                    response = requests.post(
                        f"{docling_url}/v1/convert/file/async",
                        files=files,
                        timeout=30
                    )
                
                if response.status_code != 200:
                    print(f"   ‚ùå HTTP {response.status_code}: {response.text}")
                    return None
                
                data = response.json()
                task_id = data.get('task_id')
                
                if not task_id:
                    print(f"   ‚ùå No task_id in response: {data}")
                    return None
                
                print(f"   ‚úÖ Task ID: {task_id}")
                
                # Poll for completion
                print(f"   ‚è≥ Polling for completion...")
                max_attempts = 60  # 5 minutes max
                attempt = 0
                
                while attempt < max_attempts:
                    time.sleep(5)
                    attempt += 1
                    
                    status_response = requests.get(
                        f"{docling_url}/v1/status/poll/{task_id}",
                        timeout=10
                    )
                    
                    if status_response.status_code != 200:
                        print(f"   ‚ö†Ô∏è  Status check failed: {status_response.status_code}")
                        continue
                    
                    status_data = status_response.json()
                    task_status = status_data.get('task_status', 'unknown')
                    
                    print(f"   üìä [{attempt}/60] Status: {task_status}")
                    
                    if task_status == 'success':
                        success = True
                        if success:
                            print(f"   ‚úÖ Processing complete!")
                            
                            # Get result
                            result_response = requests.get(
                                f"{docling_url}/v1/result/{task_id}",
                                timeout=30
                            )
                            
                            if result_response.status_code == 200:
                                result_data = result_response.json()
                                
                                # Save markdown (extract from document.md_content)
                                md_content = result_data.get('document', {}).get('md_content', '')
                                if md_content:
                                    md_file = output_dir / f"{basename}_docling.md"
                                    with open(md_file, 'w') as f:
                                        f.write(md_content)
                                    print(f"   üíæ Saved: {md_file.name}")
                                
                                # Save JSON
                                json_file = output_dir / f"{basename}_docling.json"
                                with open(json_file, 'w') as f:
                                    json.dump(result_data, f, indent=2)
                                print(f"   üíæ Saved: {json_file.name}")
                                
                                return True
                            else:
                                print(f"   ‚ùå Failed to get result: {result_response.status_code}")
                                return None
                        else:
                            error = status_data.get('error', 'Unknown error')
                            print(f"   ‚ùå Processing failed: {error}")
                            return None
                    
                    elif task_status == 'failure':
                        error = status_data.get('error', 'Unknown error')
                        print(f"   ‚ùå Task failed: {error}")
                        return None
                
                print(f"   ‚è±Ô∏è  Timeout after {max_attempts * 5} seconds")
                return None
                
            except Exception as e:
                print(f"   ‚ùå Error: {e}")
                return None
        
        # Find all PDFs
        pdf_files = sorted(input_dir.glob("*.pdf"))
        
        if not pdf_files:
            print("‚ùå No PDF files found!")
            exit(1)
        
        print(f"üìã Found {len(pdf_files)} ACME PDFs to process")
        print()
        
        # Process each PDF
        processed_count = 0
        for pdf_file in pdf_files:
            result = process_pdf_async(pdf_file)
            if result:
                processed_count += 1
            print()
        
        print("=" * 70)
        print(f"‚úÖ Processed {processed_count}/{len(pdf_files)} ACME PDFs")
        print("=" * 70)
        
        # Write result
        with open("/tekton/results/processed-count", "w") as f:
            f.write(str(processed_count))
        
        if processed_count < len(pdf_files):
            print(f"‚ö†Ô∏è  Warning: {len(pdf_files) - processed_count} PDFs failed")

