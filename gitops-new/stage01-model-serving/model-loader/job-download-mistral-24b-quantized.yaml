---
apiVersion: batch/v1
kind: Job
metadata:
  name: download-mistral-24b-quantized
  namespace: private-ai-demo
  labels:
    app: model-downloader
    model: mistral-24b-quantized
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: downloader
        image: python:3.11-slim
        resources:
          requests:
            memory: "6Gi"
            cpu: "2"
          limits:
            memory: "10Gi"
            cpu: "4"
        env:
        - name: HOME
          value: /models/.local
        - name: HF_HOME
          value: /models/mistral-24b-quantized/.cache/huggingface
        - name: HF_TOKEN
          valueFrom:
            secretKeyRef:
              name: huggingface-token
              key: HF_TOKEN
        - name: MODEL_ID
          value: "RedHatAI/Mistral-Small-24B-Instruct-2501-quantized.w4a16"
        - name: TARGET_DIR
          value: "/models/mistral-24b-quantized"
        - name: PYTHONUNBUFFERED
          value: "1"
        command:
          - python3
          - -u
          - -c
          - |
            import os
            import time
            
            print(f"[{time.strftime('%H:%M:%S')}] üöÄ Downloading Mistral 24B Quantized Model", flush=True)
            print(f"[{time.strftime('%H:%M:%S')}] Model: {os.environ['MODEL_ID']}", flush=True)
            print(f"[{time.strftime('%H:%M:%S')}] Size: ~13GB (w4a16 quantized)", flush=True)
            print(f"[{time.strftime('%H:%M:%S')}] Target: {os.environ['TARGET_DIR']}", flush=True)
            print("", flush=True)
            
            print(f"[{time.strftime('%H:%M:%S')}] üì¶ Installing huggingface_hub...", flush=True)
            os.system("pip install huggingface_hub==0.23.0 --user -q")
            print(f"[{time.strftime('%H:%M:%S')}] ‚úÖ Dependencies installed", flush=True)
            print("", flush=True)
            
            from huggingface_hub import snapshot_download
            
            print(f"[{time.strftime('%H:%M:%S')}] üì• Starting download...", flush=True)
            
            try:
                snapshot_download(
                    repo_id=os.environ['MODEL_ID'],
                    local_dir=os.environ['TARGET_DIR'],
                    token=os.environ['HF_TOKEN'],
                    resume_download=True,
                    max_workers=4,
                    local_dir_use_symlinks=False
                )
                print(f"[{time.strftime('%H:%M:%S')}] ‚úÖ Download complete!", flush=True)
            except Exception as e:
                print(f"[{time.strftime('%H:%M:%S')}] ‚ùå Download failed: {e}", flush=True)
                exit(1)
            
            print(f"[{time.strftime('%H:%M:%S')}] üìä Verifying files:", flush=True)
            os.system(f"du -sh {os.environ['TARGET_DIR']} && ls -la {os.environ['TARGET_DIR']}")
            print(f"[{time.strftime('%H:%M:%S')}] üéâ Model ready!", flush=True)
        volumeMounts:
          - name: models
            mountPath: /models
      volumes:
        - name: models
          persistentVolumeClaim:
            claimName: mistral-24b-quantized-pvc
