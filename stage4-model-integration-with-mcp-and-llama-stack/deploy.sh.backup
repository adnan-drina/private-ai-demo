#!/bin/bash
set -e

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ACME LithoOps Calibration Agent - Production Deployment"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Load environment variables from .env file
if [ -f "$SCRIPT_DIR/.env" ]; then
    echo "ğŸ” Loading configuration from .env file..."
    # Export variables from .env, ignoring comments and empty lines
    set -a
    source <(grep -v '^#' "$SCRIPT_DIR/.env" | grep -v '^$' | sed 's/\r$//')
    set +a
    echo "âœ… Configuration loaded"
else
    echo "âš ï¸  No .env file found. Using defaults and environment variables."
    echo "   To configure secrets, copy env.template to .env and fill in your values:"
    echo "   cp env.template .env"
fi
echo ""

# Configuration (with defaults)
PROJECT_PRIVATE_AI="${PROJECT_PRIVATE_AI:-private-ai-demo}"
PROJECT_ACME_AGENT="${PROJECT_ACME_AGENT:-acme-calibration-ops}"
POSTGRES_DB="${POSTGRES_DB:-acme_equipment}"
POSTGRES_USER="${POSTGRES_USER:-acmeadmin}"
POSTGRES_PASSWORD="${POSTGRES_PASSWORD:-acme_secure_2025}"

# Function to check if project exists
check_project() {
    local project=$1
    if ! oc get project "$project" &>/dev/null; then
        echo "âŒ Project $project does not exist"
        echo "   Please create it first: oc new-project $project"
        exit 1
    fi
    echo "âœ… Project $project exists"
}

# Function to wait for rollout
wait_for_rollout() {
    local deployment=$1
    local namespace=$2
    echo "â³ Waiting for $deployment to be ready..."
    oc rollout status deployment/$deployment -n $namespace --timeout=300s
}

# Function to wait for build
wait_for_build() {
    local build=$1
    local namespace=$2
    echo "â³ Waiting for build $build to complete..."
    oc logs -f bc/$build -n $namespace 2>&1 | grep -E "Push successful|error" | head -1
}

echo "Step 1: Checking prerequisites..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
check_project $PROJECT_PRIVATE_AI
check_project $PROJECT_ACME_AGENT

echo ""
echo "Step 2: Deploying PostgreSQL Database..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
oc apply -f gitops/database/postgresql-deployment.yaml
wait_for_rollout postgresql $PROJECT_PRIVATE_AI

echo ""
echo "Step 3: Creating PostgreSQL Secret..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
# Create PostgreSQL credentials secret from .env variables
oc create secret generic postgresql-credentials \
    --from-literal=POSTGRES_DB="$POSTGRES_DB" \
    --from-literal=POSTGRES_USER="$POSTGRES_USER" \
    --from-literal=POSTGRES_PASSWORD="$POSTGRES_PASSWORD" \
    -n $PROJECT_PRIVATE_AI \
    --dry-run=client -o yaml | oc apply -f -
echo "âœ… PostgreSQL credentials configured"

echo ""
echo "Step 4: Loading Database Schema..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
POD=$(oc get pod -l app=postgresql -n $PROJECT_PRIVATE_AI -o jsonpath='{.items[0].metadata.name}')
cat gitops/database/init-schema.sql | oc exec -i -n $PROJECT_PRIVATE_AI $POD -- \
    bash -c "PGPASSWORD=$POSTGRES_PASSWORD psql -U $POSTGRES_USER -d $POSTGRES_DB" >/dev/null
echo "âœ… Database schema loaded with equipment data"

echo ""
echo "Step 5: Creating BuildConfigs for MCP Servers..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# Database MCP BuildConfig
if ! oc get bc database-mcp -n $PROJECT_PRIVATE_AI &>/dev/null; then
    echo "Creating Database MCP BuildConfig..."
    oc new-build --name=database-mcp \
        --binary=true \
        --strategy=docker \
        -n $PROJECT_PRIVATE_AI
fi

# Slack MCP BuildConfig
if ! oc get bc slack-mcp -n $PROJECT_PRIVATE_AI &>/dev/null; then
    echo "Creating Slack MCP BuildConfig..."
    oc new-build --name=slack-mcp \
        --binary=true \
        --strategy=docker \
        -n $PROJECT_PRIVATE_AI
fi

echo ""
echo "Step 6: Building and Deploying Database MCP..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
cd mcp-servers/database-mcp
oc start-build database-mcp --from-dir=. -n $PROJECT_PRIVATE_AI --wait
cd ../..

oc apply -f gitops/mcp-servers/database-mcp/deployment.yaml
oc apply -f gitops/mcp-servers/database-mcp/service.yaml
wait_for_rollout database-mcp $PROJECT_PRIVATE_AI

echo ""
echo "Step 7: Configuring Slack Webhook (Optional)..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if [ -n "$SLACK_WEBHOOK_URL" ]; then
    echo "Creating Slack webhook secret from .env..."
    oc create secret generic slack-webhook \
        --from-literal=webhook-url="$SLACK_WEBHOOK_URL" \
        -n $PROJECT_PRIVATE_AI \
        --dry-run=client -o yaml | oc apply -f -
    echo "âœ… Slack webhook configured"
else
    echo "âš ï¸  SLACK_WEBHOOK_URL not set - Slack MCP will run in DEMO MODE (console logging)"
    echo "   To configure: Add SLACK_WEBHOOK_URL to .env file"
fi

echo ""
echo "Step 8: Building and Deploying Slack MCP..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
cd mcp-servers/slack-mcp
oc start-build slack-mcp --from-dir=. -n $PROJECT_PRIVATE_AI --wait
cd ../..

oc apply -f gitops/mcp-servers/slack-mcp/deployment.yaml
oc apply -f gitops/mcp-servers/slack-mcp/service.yaml
wait_for_rollout slack-mcp $PROJECT_PRIVATE_AI

echo ""
echo ""
echo "Step 9: Testing MCP Servers..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "Testing Database MCP..."
POD=$(oc get pod -l app=database-mcp -n $PROJECT_PRIVATE_AI -o jsonpath='{.items[0].metadata.name}')
oc exec -n $PROJECT_PRIVATE_AI $POD -- curl -s http://localhost:8080/health | grep -q "healthy" && \
    echo "âœ… Database MCP healthy" || echo "âŒ Database MCP health check failed"

echo "Testing Slack MCP..."
POD=$(oc get pod -l app=slack-mcp -n $PROJECT_PRIVATE_AI -o jsonpath='{.items[0].metadata.name}')
oc exec -n $PROJECT_PRIVATE_AI $POD -- curl -s http://localhost:8080/health | grep -q "healthy" && \
    echo "âœ… Slack MCP healthy" || echo "âŒ Slack MCP health check failed"

echo ""
echo ""
echo "Step 10: Deploying ACME Agent RBAC..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
oc apply -f acme-lithoops-agent/deploy/serviceaccount.yaml
oc apply -f acme-lithoops-agent/deploy/role.yaml -n $PROJECT_PRIVATE_AI
oc apply -f acme-lithoops-agent/deploy/rolebinding.yaml

echo ""
echo ""
echo "Step 11: Creating ACME Agent BuildConfig..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if ! oc get bc acme-agent -n $PROJECT_ACME_AGENT &>/dev/null; then
    echo "Creating ACME Agent BuildConfig..."
    oc new-build --name=acme-agent \
        --binary=true \
        --strategy=docker \
        -n $PROJECT_ACME_AGENT
fi

echo ""
echo ""
echo "Step 12: Building and Deploying ACME Agent..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
cd acme-lithoops-agent
echo "Building Quarkus application..."
mvn clean package -DskipTests -q

echo "Starting OpenShift build..."
oc start-build acme-agent --from-dir=. -n $PROJECT_ACME_AGENT --wait
cd ..

oc apply -f acme-lithoops-agent/deploy/deployment.yaml
oc apply -f acme-lithoops-agent/deploy/service.yaml
oc apply -f acme-lithoops-agent/deploy/route.yaml

echo "â³ Waiting for ACME Agent to be ready (this may take 60-90 seconds)..."
sleep 15
wait_for_rollout acme-agent $PROJECT_ACME_AGENT

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Deployment Complete!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“Š Deployment Summary:"
echo "  â€¢ PostgreSQL Database: Running with 4 equipment records"
echo "  â€¢ Database MCP: Connected to PostgreSQL"
if [ -n "$SLACK_WEBHOOK_URL" ]; then
    echo "  â€¢ Slack MCP: Connected to Slack (webhook configured)"
else
    echo "  â€¢ Slack MCP: DEMO MODE (console logging - set SLACK_WEBHOOK_URL for real Slack)"
fi
echo "  â€¢ ACME Agent: Ready for calibration checks"
echo ""
echo "ğŸŒ Access URLs:"
ROUTE=$(oc get route acme-agent -n $PROJECT_ACME_AGENT -o jsonpath='{.spec.host}' 2>/dev/null || echo "Not created")
echo "  â€¢ ACME Agent UI: https://$ROUTE"
echo "  â€¢ API Endpoint: https://$ROUTE/api/v1/ops/calibration/check"
echo ""
echo "ğŸ§ª Quick Test:"
echo "  curl -sk -X POST https://$ROUTE/api/v1/ops/calibration/check \\"
echo "    -H 'Content-Type: application/json' \\"
echo "    -d '{\"equipmentId\":\"LITHO-001\",\"telemetryFile\":\"acme_telemetry_clean.csv\"}'"
echo ""
echo "ğŸ“œ View Logs:"
echo "  â€¢ ACME Agent: oc logs -f deployment/acme-agent -n $PROJECT_ACME_AGENT"
echo "  â€¢ Database MCP: oc logs -f deployment/database-mcp -n $PROJECT_PRIVATE_AI"
echo "  â€¢ Slack MCP: oc logs -f deployment/slack-mcp -n $PROJECT_PRIVATE_AI"
echo "  â€¢ PostgreSQL: oc logs -f deployment/postgresql -n $PROJECT_PRIVATE_AI"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
