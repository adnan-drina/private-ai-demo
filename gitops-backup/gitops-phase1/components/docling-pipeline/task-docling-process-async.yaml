apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: docling-process-async
  namespace: private-ai-demo
spec:
  params:
    - name: scenario
      type: string
      default: "eu-ai-act"
    - name: docling-url
      type: string
      default: "http://shared-docling-service.ai-infrastructure.svc:5001"
  workspaces:
    - name: documents
      mountPath: /workspace/documents
  results:
    - name: processed-count
      description: Number of PDFs successfully processed
  steps:
    - name: process-all-pdfs
      image: python:3.11-slim
      env:
        - name: PYTHONUNBUFFERED
          value: "1"
        - name: SCENARIO
          value: "$(params.scenario)"
        - name: DOCLING_URL
          value: "$(params.docling-url)"
      script: |
        #!/usr/bin/env python3
        import os
        import json
        import time
        import sys
        from pathlib import Path
        
        # Install requests
        print("üì¶ Installing dependencies...")
        os.system("pip install -q requests")
        import requests
        
        print("=" * 60)
        print("  Docling PDF Processing (Smart Async)")
        print("=" * 60)
        print()
        
        scenario = os.environ.get("SCENARIO", "eu-ai-act")
        docling_url = os.environ.get("DOCLING_URL", "http://shared-docling-service.ai-infrastructure.svc:5001")
        
        input_dir = Path(f"/workspace/documents/scenario2-{scenario}")
        output_dir = Path(f"/workspace/documents/processed/scenario2-{scenario}")
        output_dir.mkdir(parents=True, exist_ok=True)
        
        print(f"Scenario: {scenario}")
        print(f"Docling URL: {docling_url}")
        print(f"Input: {input_dir}")
        print(f"Output: {output_dir}")
        print()
        
        def process_pdf_async(pdf_path):
            """Process PDF using async endpoint (for large files)"""
            print(f"   üöÄ Submitting to async endpoint...")
            
            with open(pdf_path, 'rb') as f:
                files = {'files': (pdf_path.name, f, 'application/pdf')}
                response = requests.post(
                    f"{docling_url}/v1/convert/file/async",
                    files=files,
                    timeout=30
                )
            
            if response.status_code != 200:
                print(f"   ‚ùå HTTP {response.status_code}: {response.text}")
                return None
            
            # Extract task_id
            result = response.json()
            task_id = result.get('task_id')
            if not task_id:
                print(f"   ‚ùå No task_id in response: {result}")
                return None
            
            print(f"   ‚úÖ Task ID: {task_id}")
            
            # Poll for completion
            print(f"   ‚è≥ Polling for completion...")
            max_attempts = 120  # 10 minutes
            
            for attempt in range(max_attempts):
                time.sleep(5)
                
                try:
                    status_resp = requests.get(
                        f"{docling_url}/v1/status/poll/{task_id}",
                        timeout=10
                    )
                    
                    if status_resp.status_code == 200:
                        status_data = status_resp.json()
                        status = status_data.get('status', 'unknown')
                        
                        if status == 'completed':
                            print(f"   ‚úÖ Conversion complete!")
                            
                            # Get result
                            result_resp = requests.get(
                                f"{docling_url}/v1/result/{task_id}",
                                timeout=30
                            )
                            
                            if result_resp.status_code == 200:
                                result_data = result_resp.json()
                                markdown = (
                                    result_data.get('markdown') or
                                    result_data.get('content') or
                                    result_data.get('document', {}).get('md_content') or
                                    ''
                                )
                                return markdown
                            else:
                                print(f"   ‚ùå Failed to get result: {result_resp.status_code}")
                                return None
                        
                        elif status == 'failed':
                            print(f"   ‚ùå Conversion failed: {status_data}")
                            return None
                        
                        elif status == 'processing':
                            if attempt % 6 == 0:  # Every 30 seconds
                                print(f"   ‚è≥ Still processing... ({attempt * 5}s)")
                    
                    elif status_resp.status_code == 404:
                        print(f"   ‚ö†Ô∏è  Task not found, retrying...")
                    
                except Exception as e:
                    print(f"   ‚ö†Ô∏è  Poll error: {e}, retrying...")
            
            print(f"   ‚ùå Timeout after {max_attempts * 5} seconds")
            return None
        
        def process_pdf_sync(pdf_path):
            """Process PDF using sync endpoint (for small files)"""
            print(f"   üöÄ Using sync endpoint (fast)...")
            
            with open(pdf_path, 'rb') as f:
                files = {'files': (pdf_path.name, f, 'application/pdf')}
                response = requests.post(
                    f"{docling_url}/v1/convert/file",
                    files=files,
                    timeout=120
                )
            
            if response.status_code == 200:
                result = response.json()
                markdown = (
                    result.get('markdown') or
                    result.get('content') or
                    result.get('document', {}).get('md_content') or
                    ''
                )
                return markdown
            elif response.status_code == 504:
                print(f"   ‚ö†Ô∏è  Sync timeout, will retry with async...")
                return None
            else:
                print(f"   ‚ùå HTTP {response.status_code}: {response.text[:200]}")
                return None
        
        # Process all PDFs
        pdf_files = sorted(input_dir.glob("*.pdf"))
        total_processed = 0
        total_failed = 0
        
        print(f"üìÅ Found {len(pdf_files)} PDF files")
        print()
        
        for pdf_file in pdf_files:
            print(f"üìÑ Processing: {pdf_file.name}")
            size_mb = pdf_file.stat().st_size / (1024*1024)
            print(f"   Size: {size_mb:.1f} MB")
            
            try:
                # For large files (>1MB), use async directly
                if size_mb > 1.0:
                    print(f"   üìä Large file detected, using async endpoint")
                    markdown = process_pdf_async(pdf_file)
                else:
                    # Try sync first, fallback to async if timeout
                    markdown = process_pdf_sync(pdf_file)
                    if markdown is None and "will retry" in str(sys.stdout):
                        markdown = process_pdf_async(pdf_file)
                
                if markdown:
                    md_file = output_dir / f"{pdf_file.stem}.md"
                    with open(md_file, 'w', encoding='utf-8') as f:
                        f.write(markdown)
                    print(f"   ‚úÖ Saved: {md_file.name} ({len(markdown)} chars)")
                    total_processed += 1
                else:
                    print(f"   ‚ùå Failed to get content")
                    total_failed += 1
            
            except Exception as e:
                print(f"   ‚ùå Error: {e}")
                total_failed += 1
            
            print()
        
        print("=" * 60)
        print("‚úÖ Processing complete!")
        print(f"   Processed: {total_processed}/{len(pdf_files)}")
        print(f"   Failed: {total_failed}")
        print("=" * 60)
        
        # Write result
        with open("$(results.processed-count.path)", 'w') as f:
            f.write(str(total_processed))
        
        if total_failed > 0 and total_processed == 0:
            print("‚ùå All PDFs failed!")
            exit(1)


