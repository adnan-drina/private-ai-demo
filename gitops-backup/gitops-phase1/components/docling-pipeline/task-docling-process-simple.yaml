---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: docling-process-simple
  namespace: private-ai-demo
  labels:
    app: docling-rag-pipeline
    component: docling-processing
spec:
  description: |
    Process all PDFs using Docling service (SIMPLIFIED - synchronous API).
    Uses the correct /v1/convert/file endpoint.
  
  params:
    - name: scenario
      type: string
      description: "Scenario name"
    
    - name: docling-url
      type: string
      description: "Docling service URL"
      default: "http://shared-docling-service.ai-infrastructure.svc:5001"
  
  workspaces:
    - name: documents
      description: "Workspace with PDFs and output"
      mountPath: /workspace/documents
  
  steps:
    - name: process-all-pdfs
      image: python:3.11-slim
      env:
        - name: PYTHONUNBUFFERED
          value: "1"
      script: |
        #!/usr/bin/env python3
        import os
        import json
        from pathlib import Path
        
        # Install required packages
        import subprocess
        subprocess.check_call(['pip', 'install', '-q', 'requests'])
        
        import requests
        
        print("=" * 60)
        print("  Docling PDF Processing (Simplified)")
        print("=" * 60)
        print()
        
        scenario = "$(params.scenario)"
        docling_url = "$(params.docling-url)"
        
        input_dir = Path(f"/workspace/documents/scenario2-{scenario}")
        output_dir = Path(f"/workspace/documents/processed/scenario2-{scenario}")
        output_dir.mkdir(parents=True, exist_ok=True)
        
        print(f"Scenario: {scenario}")
        print(f"Docling URL: {docling_url}")
        print(f"Input: {input_dir}")
        print(f"Output: {output_dir}")
        print()
        
        # Process all PDFs
        pdf_files = list(input_dir.glob("*.pdf"))
        print(f"üìÅ Found {len(pdf_files)} PDF files")
        print()
        
        total_processed = 0
        total_failed = 0
        
        for pdf_file in pdf_files:
            basename = pdf_file.stem
            print(f"üìÑ Processing: {pdf_file.name}")
            print(f"   Size: {pdf_file.stat().st_size / (1024*1024):.1f} MB")
            
            try:
                # Call Docling synchronous API
                print(f"   üöÄ Submitting to Docling (sync)...")
                
                with open(pdf_file, 'rb') as f:
                    files = {'files': (pdf_file.name, f, 'application/pdf')}
                    
                    # Try synchronous endpoint
                    response = requests.post(
                        f"{docling_url}/v1/convert/file",
                        files=files,
                        timeout=300  # 5 minutes
                    )
                
                if response.status_code == 200:
                    result = response.json()
                    
                    # Extract markdown content
                    markdown_content = result.get('markdown', result.get('content', ''))
                    
                    if markdown_content:
                        # Save markdown
                        md_file = output_dir / f"{basename}.md"
                        with open(md_file, 'w', encoding='utf-8') as f:
                            f.write(markdown_content)
                        
                        # Save full response
                        response_file = output_dir / f"{basename}-response.json"
                        with open(response_file, 'w', encoding='utf-8') as f:
                            json.dump(result, f, indent=2)
                        
                        print(f"   ‚úÖ Saved: {md_file.name} ({len(markdown_content)} chars)")
                        total_processed += 1
                    else:
                        print(f"   ‚ö†Ô∏è  No markdown content in response")
                        print(f"   Response keys: {list(result.keys())}")
                        total_failed += 1
                else:
                    print(f"   ‚ùå HTTP {response.status_code}: {response.text[:200]}")
                    total_failed += 1
                    
            except requests.exceptions.Timeout:
                print(f"   ‚ùå Timeout after 5 minutes")
                total_failed += 1
            except Exception as e:
                print(f"   ‚ùå Error: {e}")
                total_failed += 1
            
            print()
        
        print(f"‚úÖ Processing complete!")
        print(f"   Processed: {total_processed}")
        print(f"   Failed: {total_failed}")
        
        if total_processed == 0 and total_failed > 0:
            print()
            print("‚ö†Ô∏è  All documents failed to process!")
            print("   This might indicate:")
            print("   1. Docling service is not responding correctly")
            print("   2. API endpoint has changed")
            print("   3. PDFs are too large or corrupted")
        
        # Write result (don't fail if some succeeded)
        with open("$(results.count.path)", 'w') as f:
            f.write(str(total_processed))
  
  results:
    - name: count
      description: "Number of documents processed"

